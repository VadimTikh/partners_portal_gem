{
  "name": "[Miomente] Webhook Partners App",
  "nodes": [
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, message: \"Internal error\" }) }}",
        "options": {
          "responseCode": 500
        }
      },
      "id": "4abe8a7b-2ff4-4726-a4f1-32eb4b48fe8e",
      "name": "500",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -2336,
        -3664
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "partner-portal",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "c7bbbbce-a685-436a-8abf-75d37f1853ea",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -7936,
        -3680
      ],
      "webhookId": "partner-portal-webhook"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Webhook').item.json.query.action }}",
                    "rightValue": "login",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "efbcf2b6-8d0a-4f79-bbfa-fc7d318f3335"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "login"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Webhook').item.json.query.action }}",
                    "rightValue": "reset-password",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "2956047f-473d-4be5-b937-4388214eb3c4"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "reset-password"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Webhook').item.json.query.action }}",
                    "rightValue": "change-password",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "6541ce47-2fbc-43a0-ad09-d2185b44f4ce"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "change-password"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Webhook').item.json.query.action }}",
                    "rightValue": "get-courses",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "807f1d17-268a-4b45-bd31-952503b3ce8f"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "get-courses"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Webhook').item.json.query.action }}",
                    "rightValue": "get-course",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "3ebbb788-618b-41b6-b0b7-5bf26d27d390"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "get-course"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Webhook').item.json.query.action }}",
                    "rightValue": "update-course",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "7d97c2b7-d846-4b35-8433-ef84afbf81be"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "update-course"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Webhook').item.json.query.action }}",
                    "rightValue": "get-dates",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "c3a95c6f-a20d-4819-aa14-09c5471f91ec"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "get-dates"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Webhook').item.json.query.action }}",
                    "rightValue": "create-date",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "bc9450d8-d9b0-4813-9f64-66075b124ea4"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "create-date"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "d32f817d-1ee7-4e3c-b2d5-c8514d0fe800",
                    "leftValue": "={{ $('Webhook').item.json.query.action }}",
                    "rightValue": "delete-date",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "delete-date"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Webhook').item.json.query.action }}",
                    "rightValue": "contact",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "5241995f-6783-45e8-9a06-553985817a3e"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "contact"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "aabc7063-2a6e-4490-a6c2-4edeb30c1e0b",
                    "leftValue": "={{ $('Webhook').item.json.query.action }}",
                    "rightValue": "update-date",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "update-date"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "f0d903f8-427d-4c5f-8c8f-1847f334e1d7",
                    "leftValue": "={{ $('Webhook').item.json.query.action }}",
                    "rightValue": "verify-reset-token",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "verify-reset-token"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "ae6ce40b-a4c6-478b-83c2-aa4d401ad455",
                    "leftValue": "={{ $('Webhook').item.json.query.action }}",
                    "rightValue": "set-new-password",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "set-new-password"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "fbdc7e99-2195-448e-97c7-59f32393ee59",
                    "leftValue": "={{ $('Webhook').item.json.query.action }}",
                    "rightValue": "create-course-request",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "create-course-request"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b023c7d1-8827-426b-9964-865d2670cf84",
                    "leftValue": "={{ $('Webhook').item.json.query.action }}",
                    "rightValue": "get-course-requests",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "get-course-requests"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b2bf2226-5e0a-41ba-9d61-627bd234d933",
                    "leftValue": "={{ $('Webhook').item.json.query.action }}",
                    "rightValue": "get-course-request",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "get-course-request"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "35b71a42-2712-4165-abba-a9087c580d9e",
                    "leftValue": "={{ $('Webhook').item.json.query.action }}",
                    "rightValue": "update-course-request-status",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "update-course-request-status"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "1fc6338e-e5c7-4457-9c9b-15d0f1425b12",
                    "leftValue": "={{ $('Webhook').item.json.query.action }}",
                    "rightValue": "create-course-from-request",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "create-course-from-request"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "924f2c3e-893e-4298-8f94-610f2b11c29a",
                    "leftValue": "={{ $('Webhook').item.json.query.action }}",
                    "rightValue": "get-partners",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "get-partners"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "9805f442-9af8-4cd5-a4d4-b2d65395c428",
                    "leftValue": "={{ $('Webhook').item.json.query.action }}",
                    "rightValue": "get-partner-courses",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "get-partner-courses"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "40ea5b9d-a71a-4496-b20a-c3eb5d956234",
      "name": "Route by Action",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -7248,
        -3872
      ]
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "miomente_partner_portal_users",
          "mode": "list",
          "cachedResultName": "miomente_partner_portal_users"
        },
        "where": {
          "values": [
            {
              "column": "email",
              "value": "={{ $('Webhook').first().json.body.email }}"
            }
          ]
        },
        "options": {}
      },
      "id": "526401c1-6aa4-44ca-94f5-23c55f23e7ee",
      "name": "Find User by Email",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -3200,
        -7808
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "0Wh8S0Mv7yF5IDfG",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-user-exists",
              "leftValue": "={{ $json.id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists"
              }
            },
            {
              "id": "check-password",
              "leftValue": "={{ $json.password }}",
              "rightValue": "={{ $('Webhook').item.json.body.password }}",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "9b342877-e500-4149-b552-22f62129b64e",
      "name": "Verify Credentials",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2880,
        -7808
      ]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const email = $('Webhook').item.json.body.email;\nconst timestamp = Date.now();\nconst random = Math.random().toString(36).substring(2, 15);\n\nreturn {\n  token: `${email.split('@')[0]}-${timestamp}-${random}`,\n  email: $json.email,\n  name: $json.name,\n  id: $json.id\n};"
      },
      "id": "4d6636a0-1cdb-4e74-865c-084f115fd24d",
      "name": "Generate Token",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2592,
        -7824
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "miomente_partner_portal_users",
          "mode": "list",
          "cachedResultName": "miomente_partner_portal_users"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "token": "={{ $json.token }}",
            "id": "={{ $json.id}}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "email",
              "displayName": "email",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "name",
              "displayName": "name",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "password",
              "displayName": "password",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "token",
              "displayName": "token",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "f07636d1-cb17-4518-b7d6-6acb6400c901",
      "name": "Save Token to DB",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -2352,
        -7824
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "0Wh8S0Mv7yF5IDfG",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ \n  email: $('Generate Token').item.json.email,\n  name: $('Generate Token').item.json.name,\n  token: $('Generate Token').item.json.token,\n  role: $json.is_manager ? \"manager\" : \"partner\",\n  partnerId: $json.customer_number,\n  partnerName: $('Generate Token').item.json.name\n}) }}",
        "options": {}
      },
      "id": "6da9d0b9-b0f7-400c-8230-5d134b2db677",
      "name": "Login Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -2112,
        -7824
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ error: 'Invalid credentials' }) }}",
        "options": {
          "responseCode": 401
        }
      },
      "id": "9ca84f75-da40-4528-94f9-6e2822aaa53d",
      "name": "Login Failed",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -2880,
        -7952
      ]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Extract token from Authorization header\nconst authHeader = $('Webhook').item.json.headers.authorization || '';\nconst token = authHeader.replace('Bearer ', '');\n\nreturn {\n  token: token,\n  hasToken: token.length > 0\n};"
      },
      "id": "3f05d6e7-b237-487f-884b-4023ae4c7046",
      "name": "Extract Token",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -5728,
        -3872
      ]
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "miomente_partner_portal_users",
          "mode": "list",
          "cachedResultName": "miomente_partner_portal_users"
        },
        "limit": 1,
        "where": {
          "values": [
            {
              "column": "token",
              "value": "={{ $json.token }}"
            }
          ]
        },
        "options": {
          "outputColumns": [
            "id",
            "email",
            "name",
            "token",
            "created_at",
            "miomente_id",
            "customer_number",
            "reset_token",
            "reset_token_expires",
            "is_manager"
          ]
        }
      },
      "id": "e96bcdab-f25b-460c-b669-5f4dae3cfdae",
      "name": "Verify Token in DB",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -5504,
        -3872
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "0Wh8S0Mv7yF5IDfG",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "token-valid",
              "leftValue": "={{ $json.id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "6a7a681a-017f-4d1b-a86e-a55425e7ade2",
      "name": "Token Valid?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -5280,
        -3872
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ error: 'Unauthorized' }) }}",
        "options": {
          "responseCode": 401
        }
      },
      "id": "dc4db0ef-4a57-4a6d-8b27-3acf0c3bbe83",
      "name": "401 Unauthorized",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -5280,
        -4048
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Webhook').item.json.query.action }}",
                    "rightValue": "change-password",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "39292811-c794-426f-8334-571077738026"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "change-password"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Webhook').item.json.query.action }}",
                    "rightValue": "get-courses",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "bab52a41-f2d8-4842-b28b-dfde9e4ef919"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "get-courses"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Webhook').item.json.query.action }}",
                    "rightValue": "get-course",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "ba8693ac-1320-4f96-a5f7-5c351ce752a4"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "get-course"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Webhook').item.json.query.action }}",
                    "rightValue": "update-course",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "90ee0398-3ff5-4147-98f9-25d406b3424f"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "update-course"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Webhook').item.json.query.action }}",
                    "rightValue": "get-dates",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "c204f24e-3944-4c29-a4e3-9063ce7d7893"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "get-dates"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Webhook').item.json.query.action }}",
                    "rightValue": "create-date",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "34d80786-7a6d-4da5-a780-12b500dec8be"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "create-date"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "71f71f41-d0c8-44f9-8cd1-ab5d498b1ac6",
                    "leftValue": "={{ $('Webhook').item.json.query.action }}",
                    "rightValue": "delete-date",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "delete-date"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Webhook').item.json.query.action }}",
                    "rightValue": "contact",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "58f35fd1-b4fd-49e6-9a46-3198281232b2"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "contact"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "3fd8c99a-0e67-42b9-8bbf-868c9f4440ac",
                    "leftValue": "={{ $('Webhook').item.json.query.action }}",
                    "rightValue": "update-date",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "update-date"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "105ef02c-2f30-40d6-8dc1-2ebb93ea60ee",
                    "leftValue": "={{ $('Webhook').item.json.query.action }}",
                    "rightValue": "create-course-request",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "create-course-request"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "f41052c5-58b4-4ef0-9ca7-5854465e25c9",
                    "leftValue": "={{ $('Webhook').item.json.query.action }}",
                    "rightValue": "get-course-requests",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "get-course-requests"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "ff7534a6-26f0-4f2f-80b5-c4bc4f27319b",
                    "leftValue": "={{ $('Webhook').item.json.query.action }}",
                    "rightValue": "get-course-request",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "get-course-request"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "6fc49c75-b132-46a3-9b81-8ad024e41850",
                    "leftValue": "={{ $('Webhook').item.json.query.action }}",
                    "rightValue": "update-course-request-status",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "update-course-request-status"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "7db5e979-b06a-4916-a8e8-bc7b0a480c7a",
                    "leftValue": "={{ $('Webhook').item.json.query.action }}",
                    "rightValue": "create-course-from-request",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "create-course-from-request"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "72a872b4-41f9-4954-8b5d-d1a2401b5b62",
                    "leftValue": "={{ $('Webhook').item.json.query.action }}",
                    "rightValue": "get-partners",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "get-partners"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "dd12c633-d8db-4e66-9a71-ab5357df195b",
                    "leftValue": "={{ $('Webhook').item.json.query.action }}",
                    "rightValue": "get-partner-courses",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "get-partner-courses"
            }
          ]
        },
        "options": {}
      },
      "id": "ad3dcd69-f7f6-40c7-8513-4903b8b11483",
      "name": "Protected Route Switch",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -4848,
        -3968
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, message: 'Password changed' }) }}",
        "options": {}
      },
      "id": "0aa2ad61-fe1e-46a2-b660-bdcba266c496",
      "name": "Change Password Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -2656,
        -7040
      ],
      "notesInFlow": true,
      "notes": "TODO: Verify old password, hash new password, update DB"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json.data) }}",
        "options": {}
      },
      "id": "56dc2116-2239-4ea0-80c7-e77cd410cc67",
      "name": "Get Courses Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -2720,
        -6480
      ],
      "notesInFlow": true,
      "notes": "TODO: Query courses table WHERE user_id = verified user ID"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json.data) }}",
        "options": {}
      },
      "id": "83de9d17-d697-483c-bddb-8cc3bddc4a68",
      "name": "Get Course Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -2736,
        -6032
      ],
      "notesInFlow": true,
      "notes": "TODO: Query single course by ID, verify ownership"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({}) }}",
        "options": {}
      },
      "id": "04849d21-9ad7-40ec-9178-c0111d51fac6",
      "name": "Update Course Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -2928,
        -5568
      ],
      "notesInFlow": true,
      "notes": "TODO: Upsert course (INSERT or UPDATE based on id existence)"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json.data) }}",
        "options": {}
      },
      "id": "8d1c817c-b738-4205-957e-c908caa11927",
      "name": "Get Dates Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -2672,
        -5136
      ],
      "notesInFlow": true,
      "notes": "TODO: Query course_dates WHERE courseId = input"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ error: 'Unknown action' }) }}",
        "options": {
          "responseCode": 400
        }
      },
      "id": "494aac52-4498-4c56-bafc-582058cc7acf",
      "name": "Unknown Action",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -5744,
        -2288
      ]
    },
    {
      "parameters": {
        "content": "## AUTH (DONE)",
        "height": 368,
        "width": 1360,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3248,
        -7968
      ],
      "id": "2bc4daa9-c015-4ffd-82f2-13e88b390dd2",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "## RESET PASSWORD (DONE)",
        "height": 368,
        "width": 1360,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3248,
        -7488
      ],
      "id": "0821d51c-f1c3-4bde-9c9e-68a5f0c025bb",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "content": "## CHANGE PASSWORD (DONE)",
        "height": 368,
        "width": 1360,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3248,
        -7056
      ],
      "id": "cd55d509-f562-4c5b-8089-5bd271ac49c6",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "## GET COURSES (DONE)",
        "height": 368,
        "width": 1360,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3248,
        -6624
      ],
      "id": "62b894f7-c95a-4312-9d8f-32048f4607f6",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "content": "## GET COURSE (DONE)",
        "height": 368,
        "width": 1360,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3248,
        -6160
      ],
      "id": "3679cdaa-cc19-4970-b53b-45d65c361f48",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "content": "## UPDATE COURSE (DONE)",
        "height": 368,
        "width": 1360,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3248,
        -5712
      ],
      "id": "a1dd297b-f457-4e49-a075-d6fc9840cd2e",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "content": "## GET COURSE DATES (DONE)",
        "height": 368,
        "width": 1360,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3248,
        -5296
      ],
      "id": "99371296-a95d-4ec3-b52c-491ab9343935",
      "name": "Sticky Note6"
    },
    {
      "parameters": {
        "content": "## SEND EMAIL TO SUPPORT (DONE)",
        "height": 800,
        "width": 2704,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3248,
        -4016
      ],
      "id": "b12ac5e9-ab7b-48f0-8dc6-9792b9e09630",
      "name": "Sticky Note8"
    },
    {
      "parameters": {
        "content": "## TOKEN VALIDATION (TODO)",
        "height": 464,
        "width": 800,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -5808,
        -4064
      ],
      "id": "c92de2cd-896f-4f13-bba3-b880888b82b3",
      "name": "Sticky Note9"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n    cpe.entity_id AS 'id',\n    cpev_name.value AS 'title',\n    cpe.sku AS 'sku',\n    CASE \n        WHEN cpei_status.value = 1 THEN 'active'\n        ELSE 'inactive'\n    END AS 'status',\n    cpet_desc.value AS 'description',\n    CONCAT('https://www.miomente.de/media/catalog/product', img.value) AS 'image',\n    ROUND(cpd_price.value, 2) AS 'basePrice',\n    cpev_location.value AS 'location',\n    op.customernumber AS 'customer_number',\n    (\n        SELECT GROUP_CONCAT(DISTINCT o2.operator_id ORDER BY o2.operator_id)\n        FROM miomente_pdf_operator AS o2\n        WHERE o2.customernumber = op.customernumber\n    ) AS 'operator_ids',\n    (\n        SELECT COUNT(*)\n        FROM catalog_product_entity AS s\n        INNER JOIN catalog_product_super_link AS sl\n            ON s.entity_id = sl.product_id\n        INNER JOIN catalog_product_entity_varchar AS sn\n            ON s.entity_id = sn.entity_id\n            AND sn.attribute_id = 60\n            AND sn.store_id = 0\n        INNER JOIN catalog_product_entity_varchar AS sb\n            ON s.entity_id = sb.entity_id\n            AND sb.attribute_id = 717\n            AND sb.store_id = 0\n        WHERE sl.parent_id = cpe.entity_id\n          AND s.type_id = 'simple'\n          AND sb.value IS NOT NULL\n          AND STR_TO_DATE(\n              CONCAT(SUBSTRING_INDEX(sn.value, '-', -3), ' ', sb.value),\n              '%Y-%m-%d %H:%i'\n          ) > NOW()\n    ) AS 'available_dates'\nFROM catalog_product_entity AS cpe\n-- Title\nINNER JOIN catalog_product_entity_varchar AS cpev_name \n    ON cpe.entity_id = cpev_name.entity_id \n    AND cpev_name.attribute_id = 60\n    AND cpev_name.store_id = 0\n-- Status\nLEFT JOIN catalog_product_entity_int AS cpei_status\n    ON cpe.entity_id = cpei_status.entity_id\n    AND cpei_status.attribute_id = (SELECT attribute_id FROM eav_attribute WHERE attribute_code = 'status' AND entity_type_id = 4)\n    AND cpei_status.store_id = 0\n-- Description\nLEFT JOIN catalog_product_entity_text AS cpet_desc\n    ON cpe.entity_id = cpet_desc.entity_id\n    AND cpet_desc.attribute_id = (SELECT attribute_id FROM eav_attribute WHERE attribute_code = 'description' AND entity_type_id = 4)\n    AND cpet_desc.store_id = 0\n-- Image\nLEFT JOIN catalog_product_entity_varchar AS img\n    ON cpe.entity_id = img.entity_id\n    AND img.attribute_id = 74\n    AND img.store_id = 0\n-- Price\nLEFT JOIN catalog_product_entity_decimal AS cpd_price\n    ON cpe.entity_id = cpd_price.entity_id\n    AND cpd_price.attribute_id = (SELECT attribute_id FROM eav_attribute WHERE attribute_code = 'price' AND entity_type_id = 4)\n    AND cpd_price.store_id = 0\n-- Location (attribute_id = 578)\nLEFT JOIN catalog_product_entity_varchar AS cpev_location\n    ON cpe.entity_id = cpev_location.entity_id\n    AND cpev_location.attribute_id = 578\n    AND cpev_location.store_id = 0\n-- Operator (product -> operator_id)\nINNER JOIN catalog_product_entity_varchar AS cpev_operator \n    ON cpe.entity_id = cpev_operator.entity_id \n    AND cpev_operator.attribute_id = 700\n    AND cpev_operator.store_id = 0\n-- Operator table (operator_id -> customernumber)\nINNER JOIN miomente_pdf_operator AS op\n    ON cpev_operator.value = op.operator_id\nWHERE op.customernumber = {{ $json.customer_number.toString()}}\n  AND cpe.type_id = 'configurable'\nGROUP BY cpe.entity_id;",
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.5,
      "position": [
        -3168,
        -6480
      ],
      "id": "774337f0-22eb-40c2-8b17-cee1e29d6196",
      "name": "get base courses",
      "executeOnce": true,
      "alwaysOutputData": true,
      "credentials": {
        "mySql": {
          "id": "nX2GY6CtGttP5mMO",
          "name": "Miomente stage"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const res = $input.all().map(r => r.json)\nconst data = res\n  .filter(r => r?.id)\n  .map(r => {\n  return {\n    ...r,\n    operator_ids: r.operator_ids.split(',')\n  }\n})\nreturn {data}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2960,
        -6480
      ],
      "id": "7f61d447-a970-4182-8022-4be0a15addb9",
      "name": "json"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n    cpe.entity_id AS 'id',\n    cpev_name.value AS 'title',\n    cpev_location.value AS 'location',\n    cpe.sku AS 'sku',\n    CASE \n        WHEN cpei_status.value = 1 THEN 'active'\n        ELSE 'inactive'\n    END AS 'status',\n    cpet_desc.value AS 'description',\n    CONCAT('https://www.miomente.de/media/catalog/product', img.value) AS 'image',\n    ROUND(cpd_price.value, 2) AS 'basePrice',\n    op.customernumber AS 'customer_number',\n    (\n        SELECT GROUP_CONCAT(DISTINCT o2.operator_id ORDER BY o2.operator_id)\n        FROM miomente_pdf_operator AS o2\n        WHERE o2.customernumber = op.customernumber\n    ) AS 'operator_ids'\nFROM catalog_product_entity AS cpe\n-- Title\nINNER JOIN catalog_product_entity_varchar AS cpev_name \n    ON cpe.entity_id = cpev_name.entity_id \n    AND cpev_name.attribute_id = 60\n    AND cpev_name.store_id = 0\n-- Status\nLEFT JOIN catalog_product_entity_int AS cpei_status\n    ON cpe.entity_id = cpei_status.entity_id\n    AND cpei_status.attribute_id = (SELECT attribute_id FROM eav_attribute WHERE attribute_code = 'status' AND entity_type_id = 4)\n    AND cpei_status.store_id = 0\n-- Description\nLEFT JOIN catalog_product_entity_text AS cpet_desc\n    ON cpe.entity_id = cpet_desc.entity_id\n    AND cpet_desc.attribute_id = (SELECT attribute_id FROM eav_attribute WHERE attribute_code = 'description' AND entity_type_id = 4)\n    AND cpet_desc.store_id = 0\n-- Location\nLEFT JOIN catalog_product_entity_varchar AS cpev_location\n    ON cpe.entity_id = cpev_location.entity_id\n    AND cpev_location.attribute_id = 578\n    AND cpev_location.store_id = 0\n-- Image\nLEFT JOIN catalog_product_entity_varchar AS img\n    ON cpe.entity_id = img.entity_id\n    AND img.attribute_id = 74\n    AND img.store_id = 0\n-- Price\nLEFT JOIN catalog_product_entity_decimal AS cpd_price\n    ON cpe.entity_id = cpd_price.entity_id\n    AND cpd_price.attribute_id = (SELECT attribute_id FROM eav_attribute WHERE attribute_code = 'price' AND entity_type_id = 4)\n    AND cpd_price.store_id = 0\n-- Operator (product -> operator_id)\nINNER JOIN catalog_product_entity_varchar AS cpev_operator \n    ON cpe.entity_id = cpev_operator.entity_id \n    AND cpev_operator.attribute_id = 700\n    AND cpev_operator.store_id = 0\n-- Operator table (operator_id -> customernumber)\nINNER JOIN miomente_pdf_operator AS op\n    ON cpev_operator.value = op.operator_id\nWHERE op.customernumber = {{ $json.customer_number.toString()}}\n  AND cpe.entity_id = {{ $('Webhook').item.json.body.course_id }}\n  AND cpe.type_id = 'configurable'\nLIMIT 1;",
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.5,
      "position": [
        -3184,
        -6032
      ],
      "id": "c8c8f9f1-17d5-4620-848e-9483c884d70b",
      "name": "get base course",
      "executeOnce": true,
      "alwaysOutputData": true,
      "credentials": {
        "mySql": {
          "id": "nX2GY6CtGttP5mMO",
          "name": "Miomente stage"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const res = $input.first().json\n\nif (!res) return {}\n\nconst data = {\n  ...res,\n  operator_ids: res.operator_ids ? res.operator_ids.split(',') : []\n}\nreturn {data}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2944,
        -6032
      ],
      "id": "2ddcd2cb-b2f7-4ecd-b9d9-88a8c1c267f6",
      "name": "json1"
    },
    {
      "parameters": {
        "jsCode": "const res = $input.all().map(r => r.json)\n\nconst data = res\n  .filter(r => r?.id)\n  .map(r => {\n  return {\n    ...r,\n    operator_ids: r.operator_ids.split(',')\n  }\n})\nreturn {data}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2928,
        -5136
      ],
      "id": "96b61585-feb4-4786-a398-a5b52595660c",
      "name": "json2"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n    simple.entity_id AS 'id',\n    link.parent_id AS 'courseId',\n    CONCAT(\n        SUBSTRING_INDEX(cpev_name.value, '-', -3), \n        'T', \n        cpev_begin.value, \n        ':00Z'\n    ) AS 'dateTime',\n    CAST(IFNULL(cpev_seats.value, 0) AS UNSIGNED) AS 'capacity',\n    0 AS 'booked',\n    TIMESTAMPDIFF(\n        MINUTE,\n        STR_TO_DATE(cpev_begin.value, '%H:%i'),\n        STR_TO_DATE(cpev_end.value, '%H:%i')\n    ) AS 'duration',\n    ROUND(cpd_simple_price.value, 2) AS 'price',\n    op.customernumber AS 'customer_number',\n    (\n        SELECT GROUP_CONCAT(DISTINCT o2.operator_id ORDER BY o2.operator_id)\n        FROM miomente_pdf_operator AS o2\n        WHERE o2.customernumber = op.customernumber\n    ) AS 'operator_ids'\nFROM catalog_product_entity AS simple\n-- Link to configurable\nINNER JOIN catalog_product_super_link AS link\n    ON simple.entity_id = link.product_id\n-- Parent configurable\nINNER JOIN catalog_product_entity AS parent\n    ON link.parent_id = parent.entity_id\n-- Operator (from parent)\nINNER JOIN catalog_product_entity_varchar AS cpev_operator \n    ON parent.entity_id = cpev_operator.entity_id \n    AND cpev_operator.attribute_id = 700\n    AND cpev_operator.store_id = 0\n-- Operator table\nINNER JOIN miomente_pdf_operator AS op\n    ON cpev_operator.value = op.operator_id\n-- Name (to extract date)\nINNER JOIN catalog_product_entity_varchar AS cpev_name \n    ON simple.entity_id = cpev_name.entity_id \n    AND cpev_name.attribute_id = 60\n    AND cpev_name.store_id = 0\n-- Begin time\nLEFT JOIN catalog_product_entity_varchar AS cpev_begin\n    ON simple.entity_id = cpev_begin.entity_id \n    AND cpev_begin.attribute_id = 717\n    AND cpev_begin.store_id = 0\n-- End time\nLEFT JOIN catalog_product_entity_varchar AS cpev_end\n    ON simple.entity_id = cpev_end.entity_id \n    AND cpev_end.attribute_id = 718\n    AND cpev_end.store_id = 0\n-- Seats\nLEFT JOIN catalog_product_entity_varchar AS cpev_seats\n    ON simple.entity_id = cpev_seats.entity_id \n    AND cpev_seats.attribute_id = 720\n    AND cpev_seats.store_id = 0\n-- Price for simple product\nLEFT JOIN catalog_product_entity_decimal AS cpd_simple_price\n    ON simple.entity_id = cpd_simple_price.entity_id\n    AND cpd_simple_price.attribute_id = (SELECT attribute_id FROM eav_attribute WHERE attribute_code = 'price' AND entity_type_id = 4)\n    AND cpd_simple_price.store_id = 0\nWHERE op.customernumber = {{ $('Token Valid?').item.json.customer_number }}\n  AND link.parent_id = {{ $('Webhook').item.json.body.course_id }}\n  AND simple.type_id = 'simple'\n  AND cpev_begin.value IS NOT NULL\n  AND STR_TO_DATE(\n      CONCAT(SUBSTRING_INDEX(cpev_name.value, '-', -3), ' ', cpev_begin.value),\n      '%Y-%m-%d %H:%i'\n  ) > NOW()\nGROUP BY simple.entity_id\nORDER BY STR_TO_DATE(\n    CONCAT(SUBSTRING_INDEX(cpev_name.value, '-', -3), ' ', cpev_begin.value),\n    '%Y-%m-%d %H:%i'\n) ASC;",
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.5,
      "position": [
        -3200,
        -5136
      ],
      "id": "771a8eed-a9ef-453a-b035-1aeca9460c85",
      "name": "get events by base course",
      "executeOnce": true,
      "alwaysOutputData": true,
      "credentials": {
        "mySql": {
          "id": "nX2GY6CtGttP5mMO",
          "name": "Miomente stage"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "84c27a2a-8134-4362-8b00-2bce70f6bd20",
              "leftValue": "={{ $('Webhook').item.json.body?.password ?? \"\" }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "4f08e817-a1e7-4aa2-8750-73643861f7a1",
              "leftValue": "={{ $('Webhook').item.json.body?.newPassword ?? \"\" }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "65e8c9b4-03fc-4349-8fae-7706803eb7df",
              "leftValue": "={{ $('Webhook').item.json.body?.password ?? \"\" }}",
              "rightValue": "={{ $('Verify Token in DB').item.json.password }}",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3168,
        -6896
      ],
      "id": "7f449556-bcd7-41af-9195-0a99ad0e647c",
      "name": "passed?"
    },
    {
      "parameters": {
        "operation": "update",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "miomente_partner_portal_users",
          "mode": "list",
          "cachedResultName": "miomente_partner_portal_users"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "token": "={{ $json.token }}",
            "password": "={{ $('Webhook').item.json.body.newPassword }}"
          },
          "matchingColumns": [
            "token"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "email",
              "displayName": "email",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "name",
              "displayName": "name",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "password",
              "displayName": "password",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "token",
              "displayName": "token",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "miomente_id",
              "displayName": "miomente_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "array",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "customer_number",
              "displayName": "customer_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "9c1a00f0-0ada-4f61-a85c-317f6b1d7cc4",
      "name": "Change password in DB",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -2848,
        -7040
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "0Wh8S0Mv7yF5IDfG",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, message: 'Incorrect old password' }) }}",
        "options": {}
      },
      "id": "38242fbb-fb67-46eb-8b62-80095866b569",
      "name": "Change Password Response1",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -2656,
        -6848
      ],
      "notesInFlow": true,
      "notes": "TODO: Verify old password, hash new password, update DB"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "START TRANSACTION;\n\nUPDATE catalog_product_entity_varchar \nSET value = '{{ $('Webhook').item.json.body.title.trim()}}'\nWHERE entity_id = {{ $('Webhook').item.json.body.id }} \n  AND attribute_id = 60 \n  AND store_id = 0;\n\nUPDATE catalog_product_entity_decimal \nSET value = {{ $('Webhook').item.json.body.basePrice }}\nWHERE entity_id = {{ $('Webhook').item.json.body.id }}\n  AND attribute_id = (SELECT attribute_id FROM eav_attribute WHERE attribute_code = 'price' AND entity_type_id = 4)\n  AND store_id = 0;\n\nUPDATE catalog_product_entity_int \nSET value = CASE \n    WHEN '{{ $('Webhook').item.json.body.status }}' = 'active' THEN 1 \n    ELSE 2 \nEND\nWHERE entity_id = {{ $('Webhook').item.json.body.id }}\n  AND attribute_id = (SELECT attribute_id FROM eav_attribute WHERE attribute_code = 'status' AND entity_type_id = 4)\n  AND store_id = 0;\n\nCOMMIT;",
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.5,
      "position": [
        -3184,
        -5568
      ],
      "id": "34c083a4-6737-44a3-8e0b-007ff189660e",
      "name": "update course",
      "executeOnce": true,
      "alwaysOutputData": true,
      "credentials": {
        "mySql": {
          "id": "nX2GY6CtGttP5mMO",
          "name": "Miomente stage"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "e4248acc-e7a7-438e-a5b8-cdd38b038e87",
      "name": "Create Date Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -2720,
        -4832
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SET @event_id = {{ $('Webhook').item.json.body.date_id }};\n\nSTART TRANSACTION;\n\n-- Delete from EAV tables\nDELETE FROM catalog_product_entity_varchar WHERE entity_id = @event_id;\nDELETE FROM catalog_product_entity_text WHERE entity_id = @event_id;\nDELETE FROM catalog_product_entity_int WHERE entity_id = @event_id;\nDELETE FROM catalog_product_entity_decimal WHERE entity_id = @event_id;\nDELETE FROM catalog_product_entity_datetime WHERE entity_id = @event_id;\n\n-- Delete from link table\nDELETE FROM catalog_product_super_link WHERE product_id = @event_id;\n\n-- Delete from stock tables\nDELETE FROM cataloginventory_stock_item WHERE product_id = @event_id;\nDELETE FROM cataloginventory_stock_status WHERE product_id = @event_id;\n\n-- Delete from main entity table\nDELETE FROM catalog_product_entity WHERE entity_id = @event_id;\n\nCOMMIT;\n\nSELECT ROW_COUNT() AS 'deleted';",
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.5,
      "position": [
        -3200,
        -4320
      ],
      "id": "e92b0c62-b2df-4667-b082-a24ddd08c711",
      "name": "Delete Date SQL",
      "executeOnce": true,
      "alwaysOutputData": true,
      "credentials": {
        "mySql": {
          "id": "nX2GY6CtGttP5mMO",
          "name": "Miomente stage"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true }) }}",
        "options": {}
      },
      "id": "d16675aa-1e9e-4c97-b81b-a0dc25bdc321",
      "name": "Delete Date Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -2928,
        -4320
      ]
    },
    {
      "parameters": {
        "content": "## CREATE COURSE DATE (DONE)",
        "height": 400,
        "width": 1360,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3248,
        -4880
      ],
      "id": "6049e175-5328-4cd3-bb06-896bd4e2cfb3",
      "name": "Sticky Note10"
    },
    {
      "parameters": {
        "content": "## DELETE COURSE DATE (DONE)",
        "height": 368,
        "width": 1360,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3248,
        -4448
      ],
      "id": "605b09da-de06-4c90-b10a-70f4f1f5d2a4",
      "name": "Sticky Note11"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE catalog_product_entity_decimal \nSET value = {{ $('Webhook').item.json.body.price }}\nWHERE entity_id = {{ $('Webhook').item.json.body.date_id }}\n  AND attribute_id = (SELECT attribute_id FROM eav_attribute WHERE attribute_code = 'price' AND entity_type_id = 4)\n  AND store_id = 0;",
        "options": {}
      },
      "id": "9208bd12-666e-4a70-90d0-abdbeb4190a4",
      "name": "Update Date SQL",
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.4,
      "position": [
        -3152,
        -3024
      ],
      "credentials": {
        "mySql": {
          "id": "nX2GY6CtGttP5mMO",
          "name": "Miomente stage"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { \"success\": true, \"message\": \"Date updated successfully\" } }}",
        "options": {}
      },
      "id": "8bb89ec4-3ef5-4bea-8972-841b6233ac5d",
      "name": "Update Date Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -2896,
        -3024
      ]
    },
    {
      "parameters": {
        "content": "## UPDATE COURSE DATE (DONE)",
        "height": 368,
        "width": 1360,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3248,
        -3168
      ],
      "id": "dd8c6111-c3bd-45b9-bafd-bb5c97170649",
      "name": "Sticky Note7"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Parse input\nSET @parent_id = {{ $('Webhook').item.json.body.courseId }};\nSET @date_time = '{{ $('Webhook').item.json.body.dateTime }}';\nSET @capacity = {{ $('Webhook').item.json.body.capacity }};\nSET @duration = {{ $('Webhook').item.json.body.duration ?? 180 }};\nSET @input_price = {{ $('Webhook').item.json.body.price ?? 'NULL' }};\n\n-- Extract date and time from ISO string\nSET @event_date = DATE_FORMAT(STR_TO_DATE(@date_time, '%Y-%m-%dT%H:%i:%s'), '%Y-%m-%d');\nSET @begin_time = DATE_FORMAT(STR_TO_DATE(@date_time, '%Y-%m-%dT%H:%i:%s'), '%H:%i');\nSET @end_time = DATE_FORMAT(DATE_ADD(STR_TO_DATE(@date_time, '%Y-%m-%dT%H:%i:%s'), INTERVAL @duration MINUTE), '%H:%i');\n\n-- Get parent course data\nSET @attribute_set_id = (SELECT attribute_set_id FROM catalog_product_entity WHERE entity_id = @parent_id);\nSET @parent_sku = (SELECT sku FROM catalog_product_entity WHERE entity_id = @parent_id);\nSET @parent_name = (SELECT value FROM catalog_product_entity_varchar WHERE entity_id = @parent_id AND attribute_id = 60 AND store_id = 0);\nSET @operator_id = (SELECT value FROM catalog_product_entity_varchar WHERE entity_id = @parent_id AND attribute_id = 700 AND store_id = 0);\nSET @location = (SELECT value FROM catalog_product_entity_varchar WHERE entity_id = @parent_id AND attribute_id = 578 AND store_id = 0);\nSET @tax_class_id = (SELECT value FROM catalog_product_entity_int WHERE entity_id = @parent_id AND attribute_id = (SELECT attribute_id FROM eav_attribute WHERE attribute_code = 'tax_class_id' AND entity_type_id = 4) AND store_id = 0);\nSET @parent_price = (SELECT value FROM catalog_product_entity_decimal WHERE entity_id = @parent_id AND attribute_id = (SELECT attribute_id FROM eav_attribute WHERE attribute_code = 'price' AND entity_type_id = 4) AND store_id = 0);\n\n-- Use input price if provided, otherwise parent price\nSET @price = IFNULL(@input_price, @parent_price);\n\n-- Get additional parent attributes\nSET @keyword = (SELECT value FROM catalog_product_entity_varchar WHERE entity_id = @parent_id AND attribute_id = 590 AND store_id = 0);\nSET @subtitle = (SELECT value FROM catalog_product_entity_varchar WHERE entity_id = @parent_id AND attribute_id = 548 AND store_id = 0);\nSET @orginalname = (SELECT value FROM catalog_product_entity_varchar WHERE entity_id = @parent_id AND attribute_id = 719 AND store_id = 0);\nSET @participants = (SELECT value FROM catalog_product_entity_varchar WHERE entity_id = @parent_id AND attribute_id = 588 AND store_id = 0);\nSET @short_description = (SELECT value FROM catalog_product_entity_text WHERE entity_id = @parent_id AND attribute_id = 62 AND store_id = 0);\nSET @description = (SELECT value FROM catalog_product_entity_text WHERE entity_id = @parent_id AND attribute_id = 61 AND store_id = 0);\nSET @meta_title = (SELECT value FROM catalog_product_entity_varchar WHERE entity_id = @parent_id AND attribute_id = (SELECT attribute_id FROM eav_attribute WHERE attribute_code = 'meta_title' AND entity_type_id = 4) AND store_id = 0);\nSET @meta_description = (SELECT value FROM catalog_product_entity_varchar WHERE entity_id = @parent_id AND attribute_id = (SELECT attribute_id FROM eav_attribute WHERE attribute_code = 'meta_description' AND entity_type_id = 4) AND store_id = 0);\nSET @parent_urlpath = (SELECT value FROM catalog_product_entity_varchar WHERE entity_id = @parent_id AND attribute_id = (SELECT attribute_id FROM eav_attribute WHERE attribute_code = 'url_path' AND entity_type_id = 4) AND store_id = 0);\nSET @parent_image = (SELECT value FROM catalog_product_entity_varchar WHERE entity_id = @parent_id AND attribute_id = 74 AND store_id = 0);\nSET @parent_image_label = (SELECT value FROM catalog_product_entity_varchar WHERE entity_id = @parent_id AND attribute_id = (SELECT attribute_id FROM eav_attribute WHERE attribute_code = 'image_label' AND entity_type_id = 4) AND store_id = 0);\n\n-- Get category IDs for parent\nSET @parent_cat_ids = (\n    SELECT GROUP_CONCAT(category_id ORDER BY category_id)\n    FROM catalog_category_product\n    WHERE product_id = @parent_id\n);\n\n-- Get website_id from parent product\nSET @website_id = (SELECT website_id FROM catalog_product_website WHERE product_id = @parent_id LIMIT 1);\n\n-- Find or create date option in eav_attribute_option\nSET @date_formatted = DATE_FORMAT(STR_TO_DATE(@event_date, '%Y-%m-%d'), '%Y-%m-%d');\nSET @existing_date_option = (\n    SELECT ao.option_id \n    FROM eav_attribute_option ao\n    JOIN eav_attribute_option_value aov ON ao.option_id = aov.option_id\n    WHERE ao.attribute_id = 525 AND aov.value = @date_formatted\n    LIMIT 1\n);\n\n-- Calculate if weekend\nSET @is_weekend = (DAYOFWEEK(STR_TO_DATE(@event_date, '%Y-%m-%d')) IN (1, 7));\n\n-- Generate SKU, name, url_key\nSET @sku = CONCAT(@parent_sku, '-', @begin_time, '-', @event_date);\nSET @name = CONCAT(@parent_name, '-', @event_date);\nSET @url_key = LOWER(REPLACE(REPLACE(@name, ' ', '-'), '', 'ue'));\nSET @url_path = CONCAT(@url_key, '/');\n\n-- Build image URL\nSET @image_url = CONCAT('https://www.miomente.de/media/catalog/product/cache/0/small_image/848x/040ec09b1e35df139433887a97daa66f', @parent_image);\n\nSTART TRANSACTION;\n\n-- Create date option if not exists\nSET @date_option_id = @existing_date_option;\nIF @date_option_id IS NULL THEN\n    INSERT INTO eav_attribute_option (attribute_id, sort_order) VALUES (525, 0);\n    SET @date_option_id = LAST_INSERT_ID();\n    INSERT INTO eav_attribute_option_value (option_id, store_id, value) VALUES (@date_option_id, 0, @date_formatted);\nEND IF;\n\n-- 1. Insert main product entity\nINSERT INTO catalog_product_entity (\n    entity_type_id,\n    attribute_set_id,\n    type_id,\n    sku,\n    created_at,\n    updated_at\n) VALUES (\n    4,\n    @attribute_set_id,\n    'simple',\n    @sku,\n    NOW(),\n    NOW()\n);\n\nSET @new_id = LAST_INSERT_ID();\n\n-- 2. Insert VARCHAR attributes\nINSERT INTO catalog_product_entity_varchar (entity_type_id, attribute_id, store_id, entity_id, value)\nVALUES\n    (4, 60, 0, @new_id, @name),\n    (4, 700, 0, @new_id, @operator_id),\n    (4, 717, 0, @new_id, @begin_time),\n    (4, 718, 0, @new_id, @end_time),\n    (4, 720, 0, @new_id, @capacity),\n    (4, 578, 0, @new_id, @location),\n    (4, 590, 0, @new_id, @keyword),\n    (4, 548, 0, @new_id, @subtitle),\n    (4, 719, 0, @new_id, @orginalname),\n    (4, 588, 0, @new_id, @participants),\n    (4, (SELECT attribute_id FROM eav_attribute WHERE attribute_code = 'url_key' AND entity_type_id = 4), 0, @new_id, @url_key),\n    (4, (SELECT attribute_id FROM eav_attribute WHERE attribute_code = 'url_path' AND entity_type_id = 4), 0, @new_id, @url_path),\n    (4, (SELECT attribute_id FROM eav_attribute WHERE attribute_code = 'meta_title' AND entity_type_id = 4), 0, @new_id, @meta_title),\n    (4, (SELECT attribute_id FROM eav_attribute WHERE attribute_code = 'meta_description' AND entity_type_id = 4), 0, @new_id, @meta_description),\n    (4, (SELECT attribute_id FROM eav_attribute WHERE attribute_code = 'msrp_display_actual_price_type' AND entity_type_id = 4), 0, @new_id, '4'),\n    (4, (SELECT attribute_id FROM eav_attribute WHERE attribute_code = 'msrp_enabled' AND entity_type_id = 4), 0, @new_id, '2'),\n    (4, (SELECT attribute_id FROM eav_attribute WHERE attribute_code = 'options_container' AND entity_type_id = 4), 0, @new_id, 'container2');\n\n-- 3. Insert TEXT attributes\nINSERT INTO catalog_product_entity_text (entity_type_id, attribute_id, store_id, entity_id, value)\nVALUES\n    (4, 61, 0, @new_id, @description),\n    (4, 62, 0, @new_id, @short_description);\n\n-- 4. Insert INT attributes (including dates!)\nINSERT INTO catalog_product_entity_int (entity_type_id, attribute_id, store_id, entity_id, value)\nVALUES\n    (4, 525, 0, @new_id, @date_option_id),\n    (4, (SELECT attribute_id FROM eav_attribute WHERE attribute_code = 'status' AND entity_type_id = 4), 0, @new_id, 1),\n    (4, (SELECT attribute_id FROM eav_attribute WHERE attribute_code = 'visibility' AND entity_type_id = 4), 0, @new_id, 1),\n    (4, (SELECT attribute_id FROM eav_attribute WHERE attribute_code = 'tax_class_id' AND entity_type_id = 4), 0, @new_id, @tax_class_id),\n    (4, (SELECT attribute_id FROM eav_attribute WHERE attribute_code = 'is_imported' AND entity_type_id = 4), 0, @new_id, 0),\n    (4, (SELECT attribute_id FROM eav_attribute WHERE attribute_code = 'is_recurring' AND entity_type_id = 4), 0, @new_id, 0);\n\n-- 5. Insert DECIMAL attributes\nINSERT INTO catalog_product_entity_decimal (entity_type_id, attribute_id, store_id, entity_id, value)\nVALUES (4, (SELECT attribute_id FROM eav_attribute WHERE attribute_code = 'price' AND entity_type_id = 4), 0, @new_id, @price);\n\n-- 6. Link to parent (super_link)\nINSERT INTO catalog_product_super_link (product_id, parent_id)\nVALUES (@new_id, @parent_id);\n\n-- 7. Product relation (parent-child)\nINSERT INTO catalog_product_relation (parent_id, child_id)\nVALUES (@parent_id, @new_id);\n\n-- 8. Website assignment\nINSERT INTO catalog_product_website (product_id, website_id)\nVALUES (@new_id, @website_id);\n\n-- 9. Insert stock item\nINSERT INTO cataloginventory_stock_item (\n    product_id, stock_id, qty, is_in_stock, manage_stock, use_config_manage_stock\n) VALUES (\n    @new_id, 1, @capacity, 1, 0, 1\n);\n\n-- 10. Insert stock status\nINSERT INTO cataloginventory_stock_status (\n    product_id, website_id, stock_id, qty, stock_status\n) VALUES (\n    @new_id, @website_id, 1, @capacity, 1\n);\n\n-- 11. Insert into miomente_wishdatefinder_index for BOTH stores (6 and 4)\nINSERT INTO miomente_wishdatefinder_index (\n    simple_product_id, simple_product_date, simple_product_price, simple_product_seats,\n    configurable_product_id, configurable_product_name, configurable_product_subtitle,\n    configurable_product_cat_ids, configurable_product_urlpath, configurable_product_image,\n    configurable_product_imagelabel, configurable_product_operator_id, configurable_product_location,\n    store_id, we, updated\n) VALUES \n    (@new_id, @event_date, @price, @capacity, @parent_id, @parent_name, IFNULL(@subtitle, ''),\n     IFNULL(@parent_cat_ids, ''), IFNULL(@parent_urlpath, ''), @image_url,\n     IFNULL(@parent_image_label, ''), @operator_id, IFNULL(@location, ''), 6, @is_weekend, NOW()),\n    (@new_id, @event_date, @price, @capacity, @parent_id, @parent_name, IFNULL(@subtitle, ''),\n     IFNULL(@parent_cat_ids, ''), IFNULL(@parent_urlpath, ''), @image_url,\n     IFNULL(@parent_image_label, ''), @operator_id, IFNULL(@location, ''), 4, @is_weekend, NOW());\n\n-- 12. Insert price index for all customer groups\nINSERT INTO catalog_product_index_price (entity_id, customer_group_id, website_id, tax_class_id, price, final_price, min_price, max_price)\nVALUES \n    (@new_id, 0, 1, @tax_class_id, @price, @price, @price, @price),\n    (@new_id, 1, 1, @tax_class_id, @price, @price, @price, @price),\n    (@new_id, 2, 1, @tax_class_id, @price, @price, @price, @price),\n    (@new_id, 4, 1, @tax_class_id, @price, @price, @price, @price),\n    (@new_id, 5, 1, @tax_class_id, @price, @price, @price, @price),\n    (@new_id, 6, 1, @tax_class_id, @price, @price, @price, @price),\n    (@new_id, 7, 1, @tax_class_id, @price, @price, @price, @price),\n    (@new_id, 8, 1, @tax_class_id, @price, @price, @price, @price),\n    (@new_id, 9, 1, @tax_class_id, @price, @price, @price, @price);\n\nCOMMIT;\n\n-- Return new course date\nSELECT\n    @new_id AS 'id',\n    @parent_id AS 'courseId',\n    @date_time AS 'dateTime',\n    @capacity AS 'capacity',\n    0 AS 'booked',\n    @duration AS 'duration',\n    @price AS 'price';",
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.5,
      "position": [
        -2928,
        -4832
      ],
      "id": "62b01c9a-d759-4415-9b20-20524d629ffb",
      "name": "Create Date SQL Claude",
      "executeOnce": true,
      "alwaysOutputData": true,
      "credentials": {
        "mySql": {
          "id": "nX2GY6CtGttP5mMO",
          "name": "Miomente stage"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "78a3e742-e2ef-4325-a8b0-b0937193468d",
              "leftValue": "={{ $('Webhook').item.json.body.dateTime }}",
              "rightValue": "",
              "operator": {
                "type": "dateTime",
                "operation": "exists",
                "singleValue": true
              }
            },
            {
              "id": "d9466d32-0291-4938-94e0-1449bfaa39f1",
              "leftValue": "={{ DateTime.fromISO($('Webhook').item.json.body.dateTime).startOf('day') >= $today.plus({ days: 2 }) }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3200,
        -4736
      ],
      "id": "634b1e0b-48aa-47cc-8474-44a146d3caa1",
      "name": "date valid?"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, message: 'Invalid date (should not less then today + 2 days' }) }}",
        "options": {}
      },
      "id": "05a42462-5dda-4f24-99ea-c4abe3056dbd",
      "name": "invalid date",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -2720,
        -4656
      ],
      "notesInFlow": true,
      "notes": "TODO: Verify old password, hash new password, update DB"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('ODOO').item.json.url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"call\",\n  \"params\": {\n    \"service\": \"object\",\n    \"method\": \"execute_kw\",\n    \"args\": [\n      \"{{ $('ODOO').item.json.name_sql }}\", \n      \"{{ $('ODOO').item.json.id_user_api }}\", \n      \"{{ $('ODOO').item.json.api }}\", \n      \"helpdesk.ticket\",\n      \"create\",\n      [{\n        \"name\": \"New Partner Request - {{ $('Webhook').item.json.body.subject.replace(/\"/g, \"'\") }}\",\n        \"partner_email\": \"{{ $('Verify Token in DB').item.json.email }}\",\n        \"partner_id\": {{ $json.id }},\n        \"team_id\": 77,\n        \"user_id\": 18\n      }]\n    ]\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1728,
        -3456
      ],
      "id": "ce87bec7-168c-4fd1-8979-61c88d3ea93d",
      "name": "Create Ticket"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "1f6bf620-5555-488c-9d21-922032c69e6c",
              "leftValue": "={{ $json.result }}",
              "rightValue": "",
              "operator": {
                "type": "array",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2048,
        -3840
      ],
      "id": "7cb4c07c-a3e4-4670-8fac-b72030b1719e",
      "name": "Has Contact ?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('ODOO').item.json.url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "=json",
        "bodyParameters": {
          "parameters": [
            {}
          ]
        },
        "jsonBody": "={\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"call\",\n  \"params\": {\n    \"service\": \"object\",\n    \"method\": \"execute_kw\",\n    \"args\": [\n       \"{{ $('ODOO').item.json.name_sql }}\", \n      \"{{ $('ODOO').item.json.id_user_api }}\", \n      \"{{ $('ODOO').item.json.api }}\", \n      \"res.partner\",\n      \"create\",\n      [\n        {\n          \"email\": \"{{ $('Verify Token in DB').item.json.email }}\",\n          \"phone\": \"\",\n          \"name\": \"{{ $('Verify Token in DB').item.json.name }}\",\n          \"type\": \"contact\"\n        }\n      ]\n    ]\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1808,
        -3824
      ],
      "id": "d157e313-aaf2-4684-a78b-d6ce48879d40",
      "name": "Create Contact",
      "retryOnFail": false,
      "waitBetweenTries": 5000
    },
    {
      "parameters": {
        "jsCode": "const id = $input.first().json.result\n\nreturn {id}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1088,
        -3808
      ],
      "id": "e595a741-c859-48c4-a5c1-8194c26661a7",
      "name": "contact_id"
    },
    {
      "parameters": {
        "jsCode": "const id = $input.first().json.result[0].id\n\nreturn {id}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1264,
        -3856
      ],
      "id": "52f30a0e-3b9c-4ed4-bcc9-e341fbaabe4c",
      "name": "contact_id1"
    },
    {
      "parameters": {
        "content": "## CREATE ODOO TICKET",
        "height": 752,
        "width": 2048,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2624,
        -3984
      ],
      "id": "c03848df-2051-4988-964f-5e6377d8d719",
      "name": "Sticky Note12"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('ODOO').item.json.url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "=json",
        "bodyParameters": {
          "parameters": [
            {}
          ]
        },
        "jsonBody": "={\n    \"jsonrpc\": \"2.0\",\n    \"method\": \"call\",\n    \"params\": {\n        \"service\": \"object\",\n        \"method\": \"execute_kw\",\n        \"args\": [\n             \"{{ $('ODOO').item.json.name_sql }}\", \n      \"{{ $('ODOO').item.json.id_user_api }}\", \n      \"{{ $('ODOO').item.json.api }}\", \n            \"res.partner\",\n            \"search_read\",\n            [\n                [[\"email\", \"=\", \"{{ $('Verify Token in DB').item.json.email }}\"], [\"type\", \"=\", \"contact\"]]\n            ],\n            {\n                \"fields\": [\"id\", \"name\", \"email\"]\n            }\n        ]\n    }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2544,
        -3856
      ],
      "id": "b953ea1b-1202-4888-a8a3-4f3e4144a6eb",
      "name": "Get Contact Odoo by Email",
      "retryOnFail": false,
      "waitBetweenTries": 5000
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={{ $('CONSTANTS1').item.json.ODOO.api.fresh }}",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3040,
        -3856
      ],
      "id": "04889d23-f5ff-4258-b621-be80739613fa",
      "name": "ODOO"
    },
    {
      "parameters": {
        "content": "##  Odoo (stage/prod)",
        "height": 208,
        "width": 400,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3200,
        -3920
      ],
      "id": "96d05ab0-dca3-4359-8050-2cfa1b02b73e",
      "name": "Sticky Note13"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true }) }}",
        "options": {}
      },
      "id": "dcb786d4-7942-4e44-8590-d65258442313",
      "name": "Create Date Response1",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -752,
        -3424
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "e4ad4453-fcae-4dbf-88a0-7c0f09481673",
              "leftValue": "={{ $json.error }}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2336,
        -3856
      ],
      "id": "31526e7f-3cb0-44ef-88e8-0537440b379f",
      "name": "error"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, message: \"Internal error\" }) }}",
        "options": {
          "responseCode": 500
        }
      },
      "id": "5a2812ab-cd0b-42c1-a042-3d23b771e5b0",
      "name": "500-1",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -1584,
        -3968
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "e4ad4453-fcae-4dbf-88a0-7c0f09481673",
              "leftValue": "={{ $json.error }}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1584,
        -3824
      ],
      "id": "f938a96c-bf4b-4ca5-b397-da8fc7cb29c3",
      "name": "error1"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, message: \"Internal error\" }) }}",
        "options": {
          "responseCode": 500
        }
      },
      "id": "4d411cba-8747-4ea0-b81b-3c7bf56420cd",
      "name": "500-2",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -1488,
        -3600
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "e4ad4453-fcae-4dbf-88a0-7c0f09481673",
              "leftValue": "={{ $json.error }}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1488,
        -3456
      ],
      "id": "52636c5f-6839-4710-8ef5-6f8224732270",
      "name": "error2"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, message: \"Internal error\" }) }}",
        "options": {
          "responseCode": 500
        }
      },
      "id": "d0d9dbfd-6027-49ce-a309-47d3567d65cd",
      "name": "500-3",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -1024,
        -3584
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "e4ad4453-fcae-4dbf-88a0-7c0f09481673",
              "leftValue": "={{ $json.error }}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1024,
        -3440
      ],
      "id": "91931eb6-65e3-497f-bdb4-fd52ee630b3f",
      "name": "error3"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('ODOO').item.json.url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"call\",\n  \"params\": {\n    \"service\": \"object\",\n    \"method\": \"execute_kw\",\n    \"args\": [\n      \"{{ $('ODOO').item.json.name_sql }}\", \n      \"{{ $('ODOO').item.json.id_user_api }}\", \n      \"{{ $('ODOO').item.json.api }}\", \n      \"helpdesk.ticket\",\n      \"message_post\",\n      [{{ $json.result }}],\n      {\n        \"body\": \"{{ $('Webhook').item.json.body.message.replace(/\\\"/g, '&quot;').replace(/\\\\n/g, '<br>') }}\",\n        \"message_type\": \"comment\",\n        \"subtype_xmlid\": \"mail.mt_comment\"\n      }\n    ]\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1264,
        -3440
      ],
      "id": "047745af-37da-4e5b-bda4-4a4242e62b6e",
      "name": "Post message"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "miomente_partner_portal_users",
          "mode": "list"
        },
        "where": {
          "values": [
            {
              "column": "reset_token",
              "value": "={{ $('Webhook').first().json.body.token }}"
            }
          ]
        },
        "options": {}
      },
      "id": "43e1c552-c235-48e4-8202-9d46eacbb242",
      "name": "Find User by Reset Token",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -5744,
        -3312
      ],
      "credentials": {
        "postgres": {
          "id": "0Wh8S0Mv7yF5IDfG",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "content": "## Verify Reset Token (TODO)",
        "height": 464,
        "width": 800,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -5808,
        -3456
      ],
      "id": "4cc2a919-8a16-48d8-919b-cbebc95bcf61",
      "name": "Sticky Note15"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "miomente_partner_portal_users",
          "mode": "list",
          "cachedResultName": "miomente_partner_portal_users"
        },
        "limit": 1,
        "where": {
          "values": [
            {
              "column": "email",
              "value": "={{ $('Webhook').first().json.body.email }}"
            }
          ]
        },
        "options": {}
      },
      "id": "19fcef30-532b-44a0-b968-71b644283fcc",
      "name": "Find User for Reset1",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -3168,
        -7360
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "0Wh8S0Mv7yF5IDfG",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const generateToken = (length = 64) => {\n  const chars = 'abcdef0123456789';\n  return Array.from({ length }, () => chars[Math.floor(Math.random() * chars.length)]).join('');\n};\n\nconst email = $('Webhook').first().json.body.email;\nconst token = generateToken(64);\nconst expires = new Date(Date.now() + 3600000);\n\nreturn {\n  email: email,\n  name: $input.first().json.name,\n  id: $input.first().json.id,\n  reset_token: token,\n  reset_token_expires: expires.toISOString()\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2960,
        -7360
      ],
      "id": "aec3ff3d-49af-4538-a1c5-63b08e07c9a3",
      "name": "Generate Reset Token1"
    },
    {
      "parameters": {
        "operation": "update",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "miomente_partner_portal_users",
          "mode": "list",
          "cachedResultName": "miomente_partner_portal_users"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "reset_token": "={{ $json.reset_token }}",
            "reset_token_expires": "={{ $json.reset_token_expires }}",
            "id": "={{ $json.id }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "email",
              "displayName": "email",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "name",
              "displayName": "name",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "password",
              "displayName": "password",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "token",
              "displayName": "token",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "miomente_id",
              "displayName": "miomente_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "array",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "customer_number",
              "displayName": "customer_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "reset_token",
              "displayName": "reset_token",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "reset_token_expires",
              "displayName": "reset_token_expires",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "80769fbe-2409-4890-9609-347fd34b7c5e",
      "name": "Save Reset Token1",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -2768,
        -7360
      ],
      "credentials": {
        "postgres": {
          "id": "0Wh8S0Mv7yF5IDfG",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.sendgrid.com/v3/mail/send",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('CONSTANTS1').item.json.SEND_GRID.api_key }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"personalizations\": [{\n    \"to\": [{ \"email\": \"{{ $json.email }}\" }],\n    \"subject\": \"Passwort zurcksetzen - Miomente Partner-Portal\"\n  }],\n  \"from\": {\n    \"email\": \"bestellung@miomente.de\",\n    \"name\": \"Miomente Partner-Portal\"\n  },\n  \"content\": [{\n    \"type\": \"text/html\",\n    \"value\": \"<div style='background-color: #f9f9f9; padding: 40px 0; font-family: Helvetica, Arial, sans-serif;'> <table align='center' border='0' cellpadding='0' cellspacing='0' width='600' style='background-color: #ffffff; border-radius: 8px; overflow: hidden; border: 1px solid #eeeeee;'> <tr> <td align='center' style='padding: 30px 0; background-color: #ffffff;'> <img src='https://www.miomente.de/skin/frontend/ultimo/default/images/goldenwebage/logo.png' alt='Miomente' width='180' style='display: block;'> </td> </tr> <tr> <td style='padding: 40px 30px;'> <h2 style='color: #333333; font-size: 24px; margin-top: 0;'>Passwort zurcksetzen</h2> <p style='color: #666666; font-size: 16px; line-height: 1.5;'>Hallo {{ $json.name }},</p> <p style='color: #666666; font-size: 16px; line-height: 1.5;'>wir haben eine Anfrage zum Zurcksetzen Ihres Passworts erhalten. Klicken Sie auf den untenstehenden Button, um ein neues Passwort festzulegen:</p> <div style='padding: 30px 0; text-align: center;'> <a href=\\\"{{ $('CONSTANTS1').item.json.APP.domain }}/reset-password?token={{ $json.reset_token }}\\\" style='background-color: #e4002b; color: #ffffff; padding: 15px 30px; text-decoration: none; border-radius: 4px; font-weight: bold; display: inline-block;'>Passwort jetzt zurcksetzen</a> </div> <p style='color: #999999; font-size: 14px; line-height: 1.5;'>Dieser Link ist fr <strong>1 Stunde</strong> gltig. Falls Sie dies nicht angefragt haben, knnen Sie diese E-Mail einfach ignorieren.</p> </td> </tr> <tr> <td style='padding: 20px 30px; background-color: #f1f1f1; color: #888888; font-size: 12px; text-align: center;'> <p style='margin: 0;'>Herzliche Gre,<br><strong>Ihr Miomente-Team</strong></p> <p style='margin-top: 15px;'>Boni-Shop GmbH | <a href='https://www.miomente.de' style='color: #888888;'>www.miomente.de</a></p> </td> </tr> </table> </div>\"\n  }],\n  \"tracking_settings\": {\n    \"click_tracking\": {\n      \"enable\": false,\n      \"enable_text\": false\n    },\n    \"open_tracking\": {\n      \"enable\": false\n    }\n  }\n}",
        "options": {}
      },
      "id": "4603f0a4-4401-438f-8695-914bd60e2c8e",
      "name": "Send Reset Email1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2560,
        -7360
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, message: 'If an account exists with this email, a reset link has been sent.' }) }}",
        "options": {}
      },
      "id": "c1907580-5af0-4592-b145-2aefba4002ad",
      "name": "Reset Password Success Response1",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -2336,
        -7360
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "5062101a-22d7-44df-8ea6-540c5112bfee",
              "leftValue": "={{ $json.id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            },
            {
              "id": "fc719928-45fc-4ca4-a283-a4784324f881",
              "leftValue": "={{ DateTime.fromISO($json.reset_token_expires) > $now }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -5536,
        -3312
      ],
      "id": "651294c9-d82b-45f2-8e18-3d100407b6ee",
      "name": "Check Token Valid"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ valid: true, email: $json.email }) }}",
        "options": {}
      },
      "id": "8085b4d1-7bdb-4802-b0cb-6c7f3b136ebe",
      "name": "Respond Valid Token",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -5296,
        -3408
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ valid: false, message: 'Invalid or expired reset token' }) }}",
        "options": {
          "responseCode": 400
        }
      },
      "id": "f8745cd5-6351-4705-ac0f-7869445f3cec",
      "name": "Respond Invalid Token",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -5296,
        -3232
      ]
    },
    {
      "parameters": {
        "content": "## Set New Password (TODO)",
        "height": 464,
        "width": 976,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -5808,
        -2896
      ],
      "id": "a6e9c074-d48b-4773-ae66-09f6e92e504a",
      "name": "Sticky Note16"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ valid: false, message: 'Invalid or expired reset token' }) }}",
        "options": {
          "responseCode": 400
        }
      },
      "id": "5d820a98-8591-4d3f-aed4-ed884942ded9",
      "name": "Respond Invalid Token1",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -5248,
        -2608
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "5062101a-22d7-44df-8ea6-540c5112bfee",
              "leftValue": "={{ $json.id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            },
            {
              "id": "fc719928-45fc-4ca4-a283-a4784324f881",
              "leftValue": "={{ DateTime.fromISO($json.reset_token_expires) > $now }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -5536,
        -2720
      ],
      "id": "f92c5a40-4fd8-422d-896d-58e0bd4f78a4",
      "name": "Validate Token for Password"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "miomente_partner_portal_users",
          "mode": "list"
        },
        "where": {
          "values": [
            {
              "column": "reset_token",
              "value": "={{ $('Webhook').first().json.body.token }}"
            }
          ]
        },
        "options": {}
      },
      "id": "24cc7116-71d1-4863-a17f-2c2791e59ffc",
      "name": "Find User for Password Update",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -5744,
        -2720
      ],
      "credentials": {
        "postgres": {
          "id": "0Wh8S0Mv7yF5IDfG",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "miomente_partner_portal_users",
          "mode": "list"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "password": "={{ $('Webhook').item.json.body.newPassword }}",
            "id": "={{ $json.id }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "email",
              "displayName": "email",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "name",
              "displayName": "name",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "password",
              "displayName": "password",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "token",
              "displayName": "token",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "miomente_id",
              "displayName": "miomente_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "array",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "customer_number",
              "displayName": "customer_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "reset_token",
              "displayName": "reset_token",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "reset_token_expires",
              "displayName": "reset_token_expires",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "4211f674-ca9d-4e84-ab41-d13acd46296e",
      "name": "Update Password",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -5248,
        -2784
      ],
      "credentials": {
        "postgres": {
          "id": "0Wh8S0Mv7yF5IDfG",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "const crypto = require('crypto');\nconst newPassword = $('Webhook').item.json.body.newPassword;\nconst hashedPassword = crypto.createHash('sha256').update(newPassword).digest('hex');\n\nreturn { json: { hashedPassword, userId: $('Find User by Reset Token').item.json.id } };"
      },
      "id": "d9810cc5-26a4-488f-b529-b3cfdbf7a63a",
      "name": "Hash Password",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        -5744,
        -1936
      ]
    },
    {
      "parameters": {
        "content": "## TO DO HASH PASSWORDS",
        "height": 304,
        "width": 384
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -5792,
        -2032
      ],
      "id": "5e0dec02-4939-4d39-a2cf-1800d4635b3b",
      "name": "Sticky Note14"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, message: 'Password updated successfully' }) }}",
        "options": {}
      },
      "id": "3a6d2a58-5459-43e8-aca8-b0579b490026",
      "name": "Respond Password Updated",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -5024,
        -2784
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "NiYySod5lrKmEcYX",
          "mode": "list",
          "cachedResultUrl": "/workflow/NiYySod5lrKmEcYX",
          "cachedResultName": "[Miomente] Secrets"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -7728,
        -3680
      ],
      "id": "8f1aeead-158f-4e47-b750-21fbebdce64b",
      "name": "CONSTANTS"
    },
    {
      "parameters": {
        "jsCode": "const body = $('Webhook').first().json.body\nconst user = $('Verify Token in DB').first().json\n\nreturn {  \n  customer_number: user.customer_number, \n  partner_name: user.name, partner_email: user.email, \n  name: body.name, \n  location: body.location, \n  base_price: body.basePrice, \n  partner_description: body.partnerDescription, \n  requested_dates: JSON.stringify(body.requestedDates || []), \n  status: 'pending'\n};  "
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3168,
        -2384
      ],
      "id": "8803514b-f915-420e-8f2c-f73e142734df",
      "name": "Prepare Request Data"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO miomente_course_requests (\n    customer_number, partner_name, partner_email,\n    course_name, location, base_price, partner_description,\n    requested_dates, status\n) VALUES (\n    {{ $json.customer_number }},\n    '{{ $json.partner_name }}',\n    '{{ $json.partner_email }}',\n    '{{ $json.name }}',\n    '{{ $json.location }}',\n    {{ $json.base_price }},\n    '{{ $json.partner_description }}',\n    '{{ $json.requested_dates }}'::jsonb,\n    '{{ $json.status }}'\n) RETURNING *;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -2928,
        -2384
      ],
      "id": "f02e0dcc-1dde-48d5-b805-63d5ae90b2ff",
      "name": "Insert Course Request",
      "credentials": {
        "postgres": {
          "id": "0Wh8S0Mv7yF5IDfG",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const row = $input.first().json;\n\nreturn {\n  id: row.id,\n  partnerId: row.customer_number,\n  partnerName: row.partner_name,\n  partnerEmail: row.partner_email,\n  courseName: row.course_name,\n  location: row.location,\n  basePrice: parseFloat(row.base_price),\n  partnerDescription: row.partner_description,\n  requestedDates: row.requested_dates,\n  status: row.status,\n  createdAt: row.created_at,\n  updatedAt: row.updated_at\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2688,
        -2384
      ],
      "id": "b8003d47-9761-43ba-93a2-a8a2a07548a5",
      "name": "Format Create Response"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "2164b48f-3eca-4417-bfa0-a41141c0f47c",
      "name": "Create Request Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        560,
        -1952
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-manager-role",
              "leftValue": "={{ $json.is_manager }}",
              "rightValue": "manager",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3168,
        -2000
      ],
      "id": "bb939040-59f2-4a89-af8d-e4152af79573",
      "name": "Is Manager?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM miomente_course_requests\nORDER BY\n  CASE status\n    WHEN 'pending' THEN 1\n    WHEN 'in_moderation' THEN 2\n    ELSE 3\n  END,\n  created_at DESC;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -2864,
        -2080
      ],
      "id": "fb6c55ed-dbad-4f07-951c-b5e8c7c9bef5",
      "name": "Get All Requests",
      "credentials": {
        "postgres": {
          "id": "0Wh8S0Mv7yF5IDfG",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM miomente_course_requests\nWHERE customer_number = {{ $json.customer_number  }}\nORDER BY created_at DESC;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -2864,
        -1904
      ],
      "id": "5976028c-9ae6-43d2-b9cb-34da0c27c042",
      "name": "Get Partner Requests",
      "credentials": {
        "postgres": {
          "id": "0Wh8S0Mv7yF5IDfG",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\nreturn items.map(item => {\n  const row = item.json;\n  return {\n    id: row.id,\n    partnerId: row.customer_number,\n    partnerName: row.partner_name,\n    partnerEmail: row.partner_email,\n    name: row.course_name,\n    location: row.location,\n    basePrice: parseFloat(row.base_price),\n    partnerDescription: row.partner_description,\n    requestedDates: row.requested_dates,\n    status: row.status,\n    rejectionReason: row.rejection_reason,\n    rejectionRecommendations: row.rejection_recommendations,\n    managerNotes: row.manager_notes,\n    createdCourseId: row.created_course_id,\n    createdAt: row.created_at,\n    updatedAt: row.updated_at\n  };\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2576,
        -1968
      ],
      "id": "62d07112-6e8e-4d95-a07c-49137fd19c3c",
      "name": "Map to CamelCase"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($input.all().map(i => i.json)) }}",
        "options": {}
      },
      "id": "9adaa24b-b80a-4a89-84a1-826bed4b31ce",
      "name": "Get Requests Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -2304,
        -1968
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM miomente_course_requests WHERE id = {{ $('Webhook').item.json.body.request_id }};",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -3168,
        -1568
      ],
      "id": "eb071eca-a385-4bec-84b8-bce9350b7f66",
      "name": "Get Request By ID",
      "credentials": {
        "postgres": {
          "id": "0Wh8S0Mv7yF5IDfG",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const row = $input.first().json;\n\nif (!row || !row.id) {\n  throw new Error('Request not found');\n}\n\nreturn {\n  id: row.id,\n  partnerId: row.customer_number,\n  partnerName: row.partner_name,\n  partnerEmail: row.partner_email,\n  name: row.course_name,\n  location: row.location,\n  basePrice: parseFloat(row.base_price),\n  partnerDescription: row.partner_description,\n  requestedDates: row.requested_dates,\n  status: row.status,\n  rejectionReason: row.rejection_reason,\n  rejectionRecommendations: row.rejection_recommendations,\n  managerNotes: row.manager_notes,\n  createdCourseId: row.created_course_id,\n  createdAt: row.created_at,\n  updatedAt: row.updated_at\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2912,
        -1568
      ],
      "id": "4706584e-1628-41cc-aa93-bb1e3be6a2d2",
      "name": "Format Single Request"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "07f938f5-68da-4ea0-8bd2-4bfa8ca684a6",
      "name": "Single Request Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -2672,
        -1568
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-manager-update",
              "leftValue": "={{ $json.is_manager }}",
              "rightValue": "manager",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3168,
        -1008
      ],
      "id": "c756d601-d5f2-4162-8bc4-2e11fb55af53",
      "name": "Is Manager?1"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ error: 'Unauthorized: Manager role required' }) }}",
        "options": {
          "responseCode": 403
        }
      },
      "id": "e9f01b44-5dd8-4227-83e7-ae145b038362",
      "name": "Unauthorized Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -3168,
        -1152
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE miomente_course_requests\nSET\n    status = '{{ $('Webhook').item.json.body.status }}',\n    rejection_reason = CASE WHEN '{{ $('Webhook').item.json.body.rejectionReason }}' = '' THEN rejection_reason ELSE '{{ $('Webhook').item.json.body.rejectionReason }}' END,\n    rejection_recommendations = CASE WHEN '{{ $('Webhook').item.json.body.rejectionRecommendations }}' = '' THEN rejection_recommendations ELSE '{{ $('Webhook').item.json.body.rejectionRecommendations }}' END,\n    manager_notes = CASE WHEN '{{ $('Webhook').item.json.body.managerNotes }}' = '' THEN manager_notes ELSE '{{ $('Webhook').item.json.body.managerNotes }}' END,\n    updated_at = NOW()\nWHERE id = {{ $('Webhook').item.json.body.request_id }}\nRETURNING *;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -2896,
        -1024
      ],
      "id": "4ee0241e-000f-4d07-8cc4-134b9d9e0fe2",
      "name": "Update Request Status",
      "credentials": {
        "postgres": {
          "id": "0Wh8S0Mv7yF5IDfG",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-rejected",
              "leftValue": "={{ $json.status }}",
              "rightValue": "rejected",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1760,
        -1488
      ],
      "id": "5882c547-a7dd-47b0-9946-3f46dfa621d6",
      "name": "Is Rejected?"
    },
    {
      "parameters": {
        "jsCode": "const row = $input.first().json;\n\nreturn {\n  id: row.id,\n  partnerId: row.customer_number,\n  partnerName: row.partner_name,\n  partnerEmail: row.partner_email,\n  name: row.name,\n  location: row.location,\n  basePrice: parseFloat(row.base_price),\n  partnerDescription: row.partner_description,\n  requestedDates: row.requested_dates,\n  status: row.status,\n  rejectionReason: row.rejection_reason,\n  rejectionRecommendations: row.rejection_recommendations,\n  managerNotes: row.manager_notes,\n  createdCourseId: row.created_course_id,\n  createdAt: row.created_at,\n  updatedAt: row.updated_at\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2672,
        -1024
      ],
      "id": "006fa8eb-24f4-4b6d-a3e6-281e5dd0dcb2",
      "name": "Format Update Response"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ error: 'Unauthorized: Manager role required' }) }}",
        "options": {
          "responseCode": 403
        }
      },
      "id": "33266ae7-7964-47f9-8561-c008105ef0df",
      "name": "Unauthorized Response1",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -1760,
        -1632
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "b3cfa830-3b6f-40cd-bdbe-eeda2f53767f",
      "name": "Update Status Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -1936,
        -992
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-manager-partners",
              "leftValue": "={{ $json.is_manager }}",
              "rightValue": "manager",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3168,
        -48
      ],
      "id": "ffcedaa1-9572-493d-8f64-b4f1ff432627",
      "name": "Is Manager?2"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n    o.operator_id as id,\n    o.partnername as name,\n    o.contact_email as email,\n    o.name as companyName,\n    (\n        SELECT COUNT(*) FROM catalog_product_entity cpe\n        INNER JOIN catalog_product_entity_varchar cpev\n        ON cpe.entity_id = cpev.entity_id AND cpev.attribute_id = 700\n        WHERE cpev.value = CAST(o.operator_id AS CHAR)\n        AND cpe.type_id = 'configurable'\n    ) as coursesCount\nFROM miomente_pdf_operator o\nWHERE o.status = 1\nORDER BY o.name;",
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.4,
      "position": [
        -2896,
        -64
      ],
      "id": "e9ea5f42-e39a-4e93-8bf8-37595863bd2c",
      "name": "Get Operators from Magento",
      "credentials": {
        "mySql": {
          "id": "nX2GY6CtGttP5mMO",
          "name": "Miomente stage"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ error: 'Unauthorized: Manager role required' }) }}",
        "options": {
          "responseCode": 403
        }
      },
      "id": "5974dd1a-0084-4abf-8945-bc565fb7e2e2",
      "name": "Unauthorized Response2",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -3168,
        -176
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT customer_number, COUNT(*) as pending_count\nFROM miomente_course_requests\nWHERE status = 'pending'\nGROUP BY customer_number;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -2608,
        -64
      ],
      "id": "b7eb8401-28fe-45b4-b87f-851f79e8a680",
      "name": "Get Pending Counts",
      "credentials": {
        "postgres": {
          "id": "0Wh8S0Mv7yF5IDfG",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const operators = $('Get Operators from Magento').all();\nconst pendingCounts = $('Get Pending Counts').all();\n\nconst pendingMap = {};\npendingCounts.forEach(item => {\n  pendingMap[item.json.customer_number] = parseInt(item.json.pending_count);\n});\n\nreturn operators.map(op => ({\n  id: op.json.id,\n  name: op.json.name,\n  email: op.json.email,\n  companyName: op.json.companyName,\n  coursesCount: parseInt(op.json.coursesCount) || 0,\n  pendingRequestsCount: pendingMap[op.json.id] || 0\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2368,
        -64
      ],
      "id": "906f6842-5aae-4371-9fca-340ab91918bc",
      "name": "Merge Partner Data"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($input.all().map(i => i.json)) }}",
        "options": {}
      },
      "id": "5678b95e-221b-4a1b-a372-9e0f66eff858",
      "name": "Get Partners Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -2144,
        -64
      ],
      "executeOnce": false
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-manager-create-course",
              "leftValue": "={{ $json.is_manager }}",
              "rightValue": "manager",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3168,
        -544
      ],
      "id": "f9e6ae52-f03f-4837-9bcb-91f0e582d5f3",
      "name": "Is Manager?3"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "miomente_course_requests",
          "mode": "list",
          "cachedResultName": "miomente_course_requests"
        },
        "limit": 1,
        "where": {
          "values": [
            {
              "column": "id",
              "value": "={{ $('Webhook').item.json.body.requestId }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -2896,
        -560
      ],
      "id": "3f5559d3-51d6-4eb9-8872-34c73e43838f",
      "name": "Get Request",
      "credentials": {
        "postgres": {
          "id": "0Wh8S0Mv7yF5IDfG",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ error: 'Unauthorized: Manager role required' }) }}",
        "options": {
          "responseCode": 403
        }
      },
      "id": "330b47d2-6652-47d4-930f-6821142412bf",
      "name": "Unauthorized Response3",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -3168,
        -688
      ]
    },
    {
      "parameters": {
        "jsCode": "const request = $('Get Request').first().json;\nconst body = $('Webhook').first().json.body;\nconst operatorId = $input.first().json.operator_id\n\nconst timestamp = Date.now();\nconst sku = `PP-${operatorId}-${timestamp}`;\nconst urlKey = request.course_name\n  .toLowerCase()\n  .replace(/[]/g, m => ({:'ae',:'oe',:'ue',:'ss'})[m])\n  .replace(/[^a-z0-9]+/g, '-')\n  .replace(/-+/g, '-')\n  .replace(/^-|-$/g, '') + '-' + timestamp;\n\nreturn {\n  sku,\n  urlKey,\n  operatorId,\n  name: request.course_name,\n  subtitle: body.subtitle || '',\n  description: body.description,\n  shortDescription: body.shortDescription,\n  price: parseFloat(request.base_price),\n  location: request.location,\n  beginTime: body.beginTime,\n  endTime: body.endTime,\n  seats: body.seats,\n  participants: body.participants,\n  categoryIds: body.categoryIds,\n  keyword: body.keyword || '',\n  metaTitle: body.metaTitle || request.name,\n  metaDescription: body.metaDescription || '',\n  image: body.image || 'no_selection',\n  requestId: request.id,\n  partnerEmail: request.partner_email,\n  partnerName: request.partner_name,\n  customerNumber: request.customer_number\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2432,
        -560
      ],
      "id": "5652bed1-57d3-4c39-9fc5-388267e92eb2",
      "name": "Prepare Magento Data"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO catalog_product_entity\n(entity_type_id, attribute_set_id, type_id, sku, has_options, required_options, created_at, updated_at)\nVALUES (4, 26, 'configurable', '{{ $json.sku }}', 1, 0, NOW(), NOW());\n\nSET @product_id = LAST_INSERT_ID();\n\n-- Name (attribute_id = 60, not 73)\nINSERT INTO catalog_product_entity_varchar (entity_type_id, attribute_id, store_id, entity_id, value)\nVALUES (4, 60, 0, @product_id, '{{ $json.name }}');\n\n-- URL key (attribute_id = 86, not 97)\nINSERT INTO catalog_product_entity_varchar (entity_type_id, attribute_id, store_id, entity_id, value)\nVALUES (4, 86, 0, @product_id, '{{ $json.urlKey }}');\n\n-- Description (attribute_id = 61, not 75)\nINSERT INTO catalog_product_entity_text (entity_type_id, attribute_id, store_id, entity_id, value)\nVALUES (4, 61, 0, @product_id, '{{ $json.description }}');\n\n-- Short description (attribute_id = 62, not 76)\nINSERT INTO catalog_product_entity_text (entity_type_id, attribute_id, store_id, entity_id, value)\nVALUES (4, 62, 0, @product_id, '{{ $json.shortDescription }}');\n\n-- Price (attribute_id = 64, not 77)\nINSERT INTO catalog_product_entity_decimal (entity_type_id, attribute_id, store_id, entity_id, value)\nVALUES (4, 64, 0, @product_id, {{ $json.price }});\n\n-- Status (attribute_id = 84, not 97)\nINSERT INTO catalog_product_entity_int (entity_type_id, attribute_id, store_id, entity_id, value)\nVALUES (4, 84, 0, @product_id, 1);\n\n-- Visibility (attribute_id = 89, not 99)\nINSERT INTO catalog_product_entity_int (entity_type_id, attribute_id, store_id, entity_id, value)\nVALUES (4, 89, 0, @product_id, 4);\n\n-- Operator (700 is correct)\nINSERT INTO catalog_product_entity_varchar (entity_type_id, attribute_id, store_id, entity_id, value)\nVALUES (4, 700, 0, @product_id, '{{ $json.operatorId }}');\n\n-- Location (attribute_id = 578, not 701)\nINSERT INTO catalog_product_entity_varchar (entity_type_id, attribute_id, store_id, entity_id, value)\nVALUES (4, 578, 0, @product_id, '{{ $json.location }}');\n\nSELECT @product_id as entity_id, '{{ $json.sku }}' as sku;",
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.4,
      "position": [
        -2208,
        -560
      ],
      "id": "bab405fa-8196-4fd7-afbd-b328ae15aca4",
      "name": "Create Magento Product",
      "credentials": {
        "mySql": {
          "id": "nX2GY6CtGttP5mMO",
          "name": "Miomente stage"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE miomente_course_requests\nSET\n    status = 'approved',\n    created_course_id = {{ $('Create Magento Product').first().json.entity_id }},\n    updated_at = NOW()\nWHERE id = {{ $('Prepare Magento Data').first().json.requestId }}\nRETURNING *;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -1984,
        -560
      ],
      "id": "a5a2c90d-0bb2-4a03-a34b-21efc0a2a7b4",
      "name": "Update Request to Approved",
      "credentials": {
        "postgres": {
          "id": "0Wh8S0Mv7yF5IDfG",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const product = $('Create Magento Product').first().json;\nconst data = $('Prepare Magento Data').first().json;\n\nreturn {\n  id: product.entity_id,\n  title: data.name,\n  sku: product.sku,\n  status: 'active',\n  description: data.description,\n  basePrice: data.price,\n  location: data.location,\n  image: data.image\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1744,
        -560
      ],
      "id": "90b49262-c3ba-4ee1-834b-de8493ceae25",
      "name": "Format Course Response"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "0a1b22ae-f6b1-4770-a073-a497a7421694",
      "name": "Create Course Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -1504,
        -560
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-manager-partner-courses",
              "leftValue": "={{ $json.is_manager }}",
              "rightValue": "manager",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3168,
        416
      ],
      "id": "264a0cdf-7d00-4540-a3b4-50456f137ef3",
      "name": "Is Manager?4"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT  \n    cpe.entity_id as id, \n    cpe.sku, \n    cpev_name.value as title, \n    cpev_location.value as location, \n    cped_price.value as basePrice, \n    cpei_status.value as status\nFROM catalog_product_entity cpe  \nINNER JOIN catalog_product_entity_varchar cpev_op  \n    ON cpe.entity_id = cpev_op.entity_id \n    AND cpev_op.attribute_id = 700\nINNER JOIN miomente_pdf_operator op  \n    ON cpev_op.value = op.operator_id\nLEFT JOIN catalog_product_entity_varchar cpev_name  \n    ON cpe.entity_id = cpev_name.entity_id \n    AND cpev_name.attribute_id = 60 \n    AND cpev_name.store_id = 0\nLEFT JOIN catalog_product_entity_varchar cpev_location  \n    ON cpe.entity_id = cpev_location.entity_id \n    AND cpev_location.attribute_id = 578 \n    AND cpev_location.store_id = 0\nLEFT JOIN catalog_product_entity_decimal cped_price  \n    ON cpe.entity_id = cped_price.entity_id \n    AND cped_price.attribute_id = 64 \n    AND cped_price.store_id = 0\nLEFT JOIN catalog_product_entity_int cpei_status  \n    ON cpe.entity_id = cpei_status.entity_id \n    AND cpei_status.attribute_id = 84 \n    AND cpei_status.store_id = 0\nWHERE cpe.type_id = 'configurable'  \n    AND op.customernumber = '{{ $('Webhook').item.json.body.customer_number }}'\nORDER BY cpe.created_at DESC;",
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.4,
      "position": [
        -2896,
        400
      ],
      "id": "5237fc34-9f75-4a93-b860-75dec4e159ca",
      "name": "Get Partner Courses",
      "credentials": {
        "mySql": {
          "id": "nX2GY6CtGttP5mMO",
          "name": "Miomente stage"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($input.all().map(i => i.json)) }}",
        "options": {}
      },
      "id": "bb2782ca-2815-4c10-8790-e36ef261c189",
      "name": "Partner Courses Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -2608,
        400
      ]
    },
    {
      "parameters": {
        "content": "## create-course-requests",
        "height": 368,
        "width": 1360,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3248,
        -2512
      ],
      "id": "81b94423-78c8-4041-b837-089bc98a2d4e",
      "name": "Sticky Note17"
    },
    {
      "parameters": {
        "content": "## get-course-requests",
        "height": 368,
        "width": 1360,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3248,
        -2112
      ],
      "id": "4badc24f-1925-4b14-87c7-2e019c33342b",
      "name": "Sticky Note18"
    },
    {
      "parameters": {
        "content": "## get-course-request",
        "height": 368,
        "width": 1360,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3248,
        -1712
      ],
      "id": "feb3d205-9ff5-438e-8795-e8a5cbd35fa9",
      "name": "Sticky Note19"
    },
    {
      "parameters": {
        "content": "## update-course-request-status (DONE)",
        "height": 464,
        "width": 1584,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3248,
        -1280
      ],
      "id": "d507c95c-eedf-4bde-9e8d-66281f6217ff",
      "name": "Sticky Note20"
    },
    {
      "parameters": {
        "content": "## create-course-from-request (DONE)",
        "height": 432,
        "width": 1984,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3248,
        -752
      ],
      "id": "4515330f-94c2-4ace-b393-e3fbb204c9fe",
      "name": "Sticky Note21"
    },
    {
      "parameters": {
        "content": "## get-partners (DONE)",
        "height": 448,
        "width": 1344,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3248,
        -256
      ],
      "id": "b49a7197-c064-4f3e-8f8a-7a49abbedb4f",
      "name": "Sticky Note22"
    },
    {
      "parameters": {
        "content": "## get-partner-courses (DONE)",
        "height": 416,
        "width": 1344,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -3248,
        224
      ],
      "id": "9d301048-52ad-4c26-8d23-be669efec9d4",
      "name": "Sticky Note23"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n    u.id,\n    u.email,\n    u.name,\n    u.password_hash,\n    u.partner_id,\n    u.is_manager\nFROM miomente_partner_portal_users u\nWHERE u.email = '{{ $json.body.email }}';",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -5536,
        -4320
      ],
      "id": "79429733-e3b5-40ed-94e2-a10d1869aab2",
      "name": "Get User with Role",
      "credentials": {
        "postgres": {
          "id": "0Wh8S0Mv7yF5IDfG",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const user = $input.first().json;\n\n//      JWT \nconst token = 'generated_jwt_token';\n\nreturn {\n  email: user.email,\n  name: user.name,\n  token: token,\n  role: user.is_manager ? 'manager' : 'partner',\n  partnerId: user.partner_id,\n  partnerName: user.name\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -5328,
        -4320
      ],
      "id": "e85fe2a5-ffa5-4875-8ec0-f0e44ef4375a",
      "name": "Format Login Response"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ error: 'Unauthorized: Manager role required' }) }}",
        "options": {
          "responseCode": 403
        }
      },
      "id": "29653a53-d537-4f08-9cbe-f6b8e3e93fed",
      "name": "Unauthorized Response4",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -3168,
        288
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT operator_id FROM miomente_pdf_operator WHERE customernumber = '{{ $json.customer_number }}' AND status = 1 LIMIT 1;",
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.4,
      "position": [
        -2640,
        -560
      ],
      "id": "7f80c2a3-4b50-4cbb-85a5-32fa19ca18e1",
      "name": "Get Operator ID",
      "credentials": {
        "mySql": {
          "id": "nX2GY6CtGttP5mMO",
          "name": "Miomente stage"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, message: \"Internal error\" }) }}",
        "options": {
          "responseCode": 500
        }
      },
      "id": "bc875b8c-7701-4d0c-84b2-3c6e5bc9d019",
      "name": "500-4",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -1008,
        -2192
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('ODOO1').item.json.url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"call\",\n  \"params\": {\n    \"service\": \"object\",\n    \"method\": \"execute_kw\",\n    \"args\": [\n      \"{{ $('ODOO1').item.json.name_sql }}\",\n      \"{{ $('ODOO1').item.json.id_user_api }}\",\n      \"{{ $('ODOO1').item.json.api }}\",\n      \"helpdesk.ticket\",\n      \"create\",\n      [{\n        \"name\": \"Alert: New Course Request from {{ $('Format Create Response').item.json.partnerName }}\",\n        \"partner_id\": {{ $json.id }},\n        \"team_id\": 77,\n        \"user_id\": 18\n      }]\n    ]\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -400,
        -1984
      ],
      "id": "b8fc179e-fd5d-4726-9381-e8a1f97b9c27",
      "name": "Create Ticket1",
      "retryOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "1f6bf620-5555-488c-9d21-922032c69e6c",
              "leftValue": "={{ $json.result }}",
              "rightValue": "",
              "operator": {
                "type": "array",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -720,
        -2368
      ],
      "id": "2db89741-7d25-45de-9529-0946120574bd",
      "name": "Has Contact ?1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('ODOO1').item.json.url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "=json",
        "bodyParameters": {
          "parameters": [
            {}
          ]
        },
        "jsonBody": "={\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"call\",\n  \"params\": {\n    \"service\": \"object\",\n    \"method\": \"execute_kw\",\n    \"args\": [\n       \"{{ $('ODOO1').item.json.name_sql }}\", \n      \"{{ $('ODOO1').item.json.id_user_api }}\", \n      \"{{ $('ODOO1').item.json.api }}\", \n      \"res.partner\",\n      \"create\",\n      [\n        {\n          \"email\": \"{{ $('Verify Token in DB').item.json.email }}\",\n          \"phone\": \"\",\n          \"name\": \"{{ $('Verify Token in DB').item.json.name }}\",\n          \"type\": \"contact\"\n        }\n      ]\n    ]\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -480,
        -2352
      ],
      "id": "c7a24400-79d8-45b3-a716-44afa8e2facf",
      "name": "Create Contact1",
      "retryOnFail": true,
      "waitBetweenTries": 1000
    },
    {
      "parameters": {
        "jsCode": "const id = $input.first().json.result\n\nreturn {id}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        240,
        -2336
      ],
      "id": "6adfd4f8-cd0f-426c-b2fd-d00ff2e84a15",
      "name": "contact_id2"
    },
    {
      "parameters": {
        "jsCode": "const id = $input.first().json.result[0].id\n\nreturn {id}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        64,
        -2384
      ],
      "id": "eddfb722-7f01-459c-a0dc-4bae29a78a2c",
      "name": "contact_id3"
    },
    {
      "parameters": {
        "content": "## CREATE ODOO TICKET",
        "height": 752,
        "width": 2064,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1296,
        -2512
      ],
      "id": "c2981b72-fa5b-4015-a097-db816ef01bd1",
      "name": "Sticky Note24"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('ODOO1').item.json.url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "=json",
        "bodyParameters": {
          "parameters": [
            {}
          ]
        },
        "jsonBody": "={\n    \"jsonrpc\": \"2.0\",\n    \"method\": \"call\",\n    \"params\": {\n        \"service\": \"object\",\n        \"method\": \"execute_kw\",\n        \"args\": [\n             \"{{ $('ODOO1').item.json.name_sql }}\", \n      \"{{ $('ODOO1').item.json.id_user_api }}\", \n      \"{{ $('ODOO1').item.json.api }}\", \n            \"res.partner\",\n            \"search_read\",\n            [\n                [[\"email\", \"=\", \"{{ $('Verify Token in DB').item.json.email }}\"], [\"type\", \"=\", \"contact\"]]\n            ],\n            {\n                \"fields\": [\"id\", \"name\", \"email\"]\n            }\n        ]\n    }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1216,
        -2384
      ],
      "id": "e1129ba9-22e0-49f5-9dcf-79201e347adf",
      "name": "Get Contact Odoo by Email1",
      "retryOnFail": true,
      "waitBetweenTries": 1000
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={{ $('CONSTANTS').item.json.ODOO.api.fresh }}",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1584,
        -2384
      ],
      "id": "dc4ac7b5-6dca-489d-997a-eecb6cbcf14b",
      "name": "ODOO1"
    },
    {
      "parameters": {
        "content": "##  Odoo (stage/prod)",
        "height": 208,
        "width": 384,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1728,
        -2448
      ],
      "id": "aa214cf2-697d-472d-973d-2a28ddb47452",
      "name": "Sticky Note25"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "e4ad4453-fcae-4dbf-88a0-7c0f09481673",
              "leftValue": "={{ $json.error }}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1008,
        -2384
      ],
      "id": "bab24bfd-27ac-472f-ae01-fcb17b2529ae",
      "name": "error4"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, message: \"Internal error\" }) }}",
        "options": {
          "responseCode": 500
        }
      },
      "id": "bcad348b-7c17-4517-8b6a-f146aa07ad4b",
      "name": "500-5",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -256,
        -2496
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "e4ad4453-fcae-4dbf-88a0-7c0f09481673",
              "leftValue": "={{ $json.error }}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -256,
        -2352
      ],
      "id": "9cbb4f6c-b79a-4455-af24-47f48b900e27",
      "name": "error5"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, message: \"Internal error\" }) }}",
        "options": {
          "responseCode": 500
        }
      },
      "id": "38b693f4-17e1-45ec-a4e8-97fedf650d00",
      "name": "500-6",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -160,
        -2128
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "e4ad4453-fcae-4dbf-88a0-7c0f09481673",
              "leftValue": "={{ $json.error }}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -160,
        -1984
      ],
      "id": "531dfb56-a9bf-40da-8629-293b2b647b77",
      "name": "error6"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, message: \"Internal error\" }) }}",
        "options": {
          "responseCode": 500
        }
      },
      "id": "983d91f4-6fcd-4111-8c11-fda6393cd7ce",
      "name": "500-7",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        320,
        -2112
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "e4ad4453-fcae-4dbf-88a0-7c0f09481673",
              "leftValue": "={{ $json.error }}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        320,
        -1968
      ],
      "id": "a97a2ee4-59fa-4f7d-b259-1d270185d1b9",
      "name": "error7"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('ODOO1').item.json.url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"call\",\n  \"params\": {\n    \"service\": \"object\",\n    \"method\": \"execute_kw\",\n    \"args\": [\n      \"{{ $('ODOO1').item.json.name_sql }}\",\n      \"{{ $('ODOO1').item.json.id_user_api }}\",\n      \"{{ $('ODOO1').item.json.api }}\",\n      \"helpdesk.ticket\",\n      \"message_post\",\n      [{{ $json.result }}],\n      {\n          \"body\": \"{{ $('CONSTANTS').item.json.APP.domain }}/manager/requests/4 \",\n          \"message_type\": \"comment\",\n          \"subtype_xmlid\": \"mail.mt_comment\",\n          \"partner_ids\": [{{ $json.id }}]\n      }\n    ]\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        80,
        -1968
      ],
      "id": "e9e24c19-ba94-4171-980a-25fc20877f96",
      "name": "Post message1",
      "retryOnFail": true
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "check-approved",
                    "leftValue": "={{ $json.status }}",
                    "rightValue": "approved",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "approved"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "check-rejected",
                    "leftValue": "={{ $json.status }}",
                    "rightValue": "rejected",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "rejected"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "8eea27fe-9a43-4498-b8cd-eef32903452f",
      "name": "Check Status",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -2464,
        -1040
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.sendgrid.com/v3/mail/send",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('CONSTANTS').item.json.SEND_GRID.api_key }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"personalizations\": [{\n    \"to\": [{ \"email\": \"{{ $json.partnerEmail }}\" }],\n    \"subject\": \"Kursanfrage genehmigt: {{ $json.name }}\"\n  }],\n  \"from\": {\n    \"email\": \"bestellung@miomente.de\",\n    \"name\": \"Miomente Partner-Portal\"\n  },\n  \"content\": [{\n    \"type\": \"text/html\",\n    \"value\": \"<div style='background-color: #f9f9f9; padding: 40px 0; font-family: Helvetica, Arial, sans-serif;'><table align='center' border='0' cellpadding='0' cellspacing='0' width='600' style='background-color: #ffffff; border-radius: 8px; overflow: hidden; border: 1px solid #eeeeee;'><tr><td align='center' style='padding: 30px 0; background-color: #ffffff;'><img src='https://www.miomente.de/skin/frontend/ultimo/default/images/goldenwebage/logo.png' alt='Miomente' width='180' style='display: block;'></td></tr><tr><td style='padding: 40px 30px;'><h2 style='color: #2e7d32; font-size: 24px; margin-top: 0;'>Ihre Kursanfrage wurde genehmigt!</h2><p style='color: #666666; font-size: 16px; line-height: 1.5;'>Hallo {{ $json.partnerName }},</p><p style='color: #666666; font-size: 16px; line-height: 1.5;'>wir freuen uns, Ihnen mitteilen zu knnen, dass Ihre Kursanfrage fr <strong>\\\"{{ $json.name }}\\\"</strong> genehmigt wurde!</p><p style='color: #666666; font-size: 16px; line-height: 1.5;'>Ihr Kurs ist jetzt im System angelegt und kann im Partner Portal eingesehen und verwaltet werden.</p><div style='padding: 30px 0; text-align: center;'><a href='{{ $('CONSTANTS').item.json.APP.domain }}/dashboard/editor/{{ $json.createdCourseId }}' style='background-color: #2e7d32; color: #ffffff; padding: 15px 30px; text-decoration: none; border-radius: 4px; font-weight: bold; display: inline-block;'>Kurs im Portal ansehen</a></div></td></tr><tr><td style='padding: 20px 30px; background-color: #f1f1f1; color: #888888; font-size: 12px; text-align: center;'><p style='margin: 0;'>Herzliche Gre,<br><strong>Ihr Miomente-Team</strong></p><p style='margin-top: 15px;'>Boni-Shop GmbH | <a href='https://www.miomente.de' style='color: #888888;'>www.miomente.de</a></p></td></tr></table></div>\"\n  }],\n  \"tracking_settings\": {\n    \"click_tracking\": { \"enable\": false, \"enable_text\": false },\n    \"open_tracking\": { \"enable\": false }\n  }\n}",
        "options": {}
      },
      "id": "b3069804-f536-4b82-a48e-a41258f27f22",
      "name": "Send Approved Email",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2208,
        -1264
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.sendgrid.com/v3/mail/send",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('CONSTANTS1').item.json.SEND_GRID.api_key }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"personalizations\": [{\n    \"to\": [{ \"email\": \"{{ $json.partnerEmail }}\" }],\n    \"subject\": \"Kursanfrage abgelehnt: {{ $json.name }}\"\n  }],\n  \"from\": {\n    \"email\": \"bestellung@miomente.de\",\n    \"name\": \"Miomente Partner-Portal\"\n  },\n  \"content\": [{\n    \"type\": \"text/html\",\n    \"value\": \"<div style='background-color: #f9f9f9; padding: 40px 0; font-family: Helvetica, Arial, sans-serif;'><table align='center' border='0' cellpadding='0' cellspacing='0' width='600' style='background-color: #ffffff; border-radius: 8px; overflow: hidden; border: 1px solid #eeeeee;'><tr><td align='center' style='padding: 30px 0; background-color: #ffffff;'><img src='https://www.miomente.de/skin/frontend/ultimo/default/images/goldenwebage/logo.png' alt='Miomente' width='180' style='display: block;'></td></tr><tr><td style='padding: 40px 30px;'><h2 style='color: #c62828; font-size: 24px; margin-top: 0;'>Ihre Kursanfrage wurde abgelehnt</h2><p style='color: #666666; font-size: 16px; line-height: 1.5;'>Hallo {{ $json.partnerName }},</p><p style='color: #666666; font-size: 16px; line-height: 1.5;'>leider mssen wir Ihnen mitteilen, dass Ihre Kursanfrage fr <strong>\\\"{{ $json.name }}\\\"</strong> nicht genehmigt werden konnte.</p>{{ $json.rejectionReason ? \\\"<div style='background-color: #fff3e0; border-left: 4px solid #ff9800; padding: 15px; margin: 20px 0;'><strong style='color: #e65100;'>Ablehnungsgrund:</strong><p style='color: #666666; margin: 10px 0 0 0;'>\\\" + $json.rejectionReason + \\\"</p></div>\\\" : \\\"\\\" }}{{ $json.rejectionRecommendations ? \\\"<div style='background-color: #e3f2fd; border-left: 4px solid #2196f3; padding: 15px; margin: 20px 0;'><strong style='color: #1565c0;'>Unsere Empfehlungen:</strong><p style='color: #666666; margin: 10px 0 0 0;'>\\\" + $json.rejectionRecommendations + \\\"</p></div>\\\" : \\\"\\\" }}<p style='color: #666666; font-size: 16px; line-height: 1.5;'>Bei Fragen stehen wir Ihnen gerne zur Verfgung.</p><div style='padding: 30px 0; text-align: center;'><a href='{{ $('CONSTANTS1').item.json.APP.domain }}/dashboard/contact' style='background-color: #e4002b; color: #ffffff; padding: 15px 30px; text-decoration: none; border-radius: 4px; font-weight: bold; display: inline-block;'>Support kontaktieren</a></div></td></tr><tr><td style='padding: 20px 30px; background-color: #f1f1f1; color: #888888; font-size: 12px; text-align: center;'><p style='margin: 0;'>Herzliche Gre,<br><strong>Ihr Miomente-Team</strong></p><p style='margin-top: 15px;'>Boni-Shop GmbH | <a href='https://www.miomente.de' style='color: #888888;'>www.miomente.de</a></p></td></tr></table></div>\"\n  }],\n  \"tracking_settings\": {\n    \"click_tracking\": { \"enable\": false, \"enable_text\": false },\n    \"open_tracking\": { \"enable\": false }\n  }\n}",
        "options": {}
      },
      "id": "33dcbdf9-973a-4287-972a-f1d23194d513",
      "name": "Send Rejected Email",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2208,
        -1104
      ]
    }
  ],
  "pinData": {
    "Webhook": [
      {
        "json": {
          "headers": {
            "host": "n8n.boni.tools",
            "x-real-ip": "172.64.198.32",
            "x-real-port": "13997",
            "x-forwarded-for": "62.16.23.125, 172.64.198.32",
            "remote-host": "172.64.198.32",
            "connection": "upgrade",
            "content-length": "103",
            "accept": "application/json, text/plain, */*",
            "content-type": "application/json",
            "accept-encoding": "gzip, br",
            "user-agent": "axios/1.13.2",
            "cf-ray": "9bd04add8a3edb64-WAW",
            "authorization": "Bearer info-1768238506940-7yu0b3a05bf",
            "cdn-loop": "cloudflare; loops=1",
            "cf-connecting-ip": "62.16.23.125",
            "cf-ipcountry": "UA",
            "cf-visitor": "{\"scheme\":\"https\"}",
            "x-forwarded-proto": "https"
          },
          "params": {},
          "query": {
            "action": "create-date"
          },
          "body": {
            "courseId": 110665,
            "dateTime": "2026-01-30T23:04:00.000Z",
            "capacity": 10,
            "duration": 180,
            "price": "115.00"
          },
          "webhookUrl": "https://n8n.boni.tools/webhook/partner-portal",
          "executionMode": "production"
        }
      }
    ]
  },
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "CONSTANTS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route by Action": {
      "main": [
        [
          {
            "node": "Find User by Email",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Find User for Reset1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract Token",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract Token",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract Token",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract Token",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract Token",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract Token",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract Token",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract Token",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract Token",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Find User by Reset Token",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Find User for Password Update",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract Token",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract Token",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract Token",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract Token",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract Token",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract Token",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract Token",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Unknown Action",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find User by Email": {
      "main": [
        [
          {
            "node": "Verify Credentials",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verify Credentials": {
      "main": [
        [
          {
            "node": "Generate Token",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Login Failed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Token": {
      "main": [
        [
          {
            "node": "Save Token to DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Token to DB": {
      "main": [
        [
          {
            "node": "Login Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Token": {
      "main": [
        [
          {
            "node": "Verify Token in DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verify Token in DB": {
      "main": [
        [
          {
            "node": "Token Valid?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Token Valid?": {
      "main": [
        [
          {
            "node": "Protected Route Switch",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "401 Unauthorized",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Protected Route Switch": {
      "main": [
        [
          {
            "node": "passed?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "get base courses",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "get base course",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "update course",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "get events by base course",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "date valid?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Delete Date SQL",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ODOO",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update Date SQL",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare Request Data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Is Manager?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Request By ID",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Is Manager?1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Is Manager?3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Is Manager?2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Is Manager?4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get base courses": {
      "main": [
        [
          {
            "node": "json",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "json": {
      "main": [
        [
          {
            "node": "Get Courses Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get base course": {
      "main": [
        [
          {
            "node": "json1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "json1": {
      "main": [
        [
          {
            "node": "Get Course Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "json2": {
      "main": [
        [
          {
            "node": "Get Dates Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get events by base course": {
      "main": [
        [
          {
            "node": "json2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "passed?": {
      "main": [
        [
          {
            "node": "Change password in DB",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Change Password Response1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Change password in DB": {
      "main": [
        [
          {
            "node": "Change Password Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "update course": {
      "main": [
        [
          {
            "node": "Update Course Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Date SQL": {
      "main": [
        [
          {
            "node": "Delete Date Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Date SQL": {
      "main": [
        [
          {
            "node": "Update Date Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Date SQL Claude": {
      "main": [
        [
          {
            "node": "Create Date Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "date valid?": {
      "main": [
        [
          {
            "node": "Create Date SQL Claude",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "invalid date",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Ticket": {
      "main": [
        [
          {
            "node": "error2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Contact ?": {
      "main": [
        [
          {
            "node": "contact_id1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Create Contact",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Contact": {
      "main": [
        [
          {
            "node": "error1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "contact_id": {
      "main": [
        [
          {
            "node": "Create Ticket",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "contact_id1": {
      "main": [
        [
          {
            "node": "Create Ticket",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Contact Odoo by Email": {
      "main": [
        [
          {
            "node": "error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ODOO": {
      "main": [
        [
          {
            "node": "Get Contact Odoo by Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "error": {
      "main": [
        [
          {
            "node": "500",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Has Contact ?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "error1": {
      "main": [
        [
          {
            "node": "500-1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "contact_id",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "error2": {
      "main": [
        [
          {
            "node": "500-2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Post message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "error3": {
      "main": [
        [
          {
            "node": "500-3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Create Date Response1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Post message": {
      "main": [
        [
          {
            "node": "error3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find User for Reset1": {
      "main": [
        [
          {
            "node": "Generate Reset Token1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Reset Token1": {
      "main": [
        [
          {
            "node": "Save Reset Token1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Reset Token1": {
      "main": [
        [
          {
            "node": "Send Reset Email1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Reset Email1": {
      "main": [
        [
          {
            "node": "Reset Password Success Response1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find User by Reset Token": {
      "main": [
        [
          {
            "node": "Check Token Valid",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Token Valid": {
      "main": [
        [
          {
            "node": "Respond Valid Token",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond Invalid Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Token for Password": {
      "main": [
        [
          {
            "node": "Update Password",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond Invalid Token1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find User for Password Update": {
      "main": [
        [
          {
            "node": "Validate Token for Password",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Password": {
      "main": [
        [
          {
            "node": "Respond Password Updated",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CONSTANTS": {
      "main": [
        [
          {
            "node": "Route by Action",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Request Data": {
      "main": [
        [
          {
            "node": "Insert Course Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert Course Request": {
      "main": [
        [
          {
            "node": "Format Create Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Create Response": {
      "main": [
        [
          {
            "node": "ODOO1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Manager?": {
      "main": [
        [
          {
            "node": "Get All Requests",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Partner Requests",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get All Requests": {
      "main": [
        [
          {
            "node": "Map to CamelCase",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Partner Requests": {
      "main": [
        [
          {
            "node": "Map to CamelCase",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Map to CamelCase": {
      "main": [
        [
          {
            "node": "Get Requests Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Request By ID": {
      "main": [
        [
          {
            "node": "Format Single Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Single Request": {
      "main": [
        [
          {
            "node": "Single Request Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Manager?1": {
      "main": [
        [
          {
            "node": "Update Request Status",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Unauthorized Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Request Status": {
      "main": [
        [
          {
            "node": "Format Update Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Rejected?": {
      "main": [
        [
          {
            "node": "Unauthorized Response1",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Format Update Response": {
      "main": [
        [
          {
            "node": "Check Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Manager?2": {
      "main": [
        [
          {
            "node": "Get Operators from Magento",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Unauthorized Response2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Operators from Magento": {
      "main": [
        [
          {
            "node": "Get Pending Counts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Pending Counts": {
      "main": [
        [
          {
            "node": "Merge Partner Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Partner Data": {
      "main": [
        [
          {
            "node": "Get Partners Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Manager?3": {
      "main": [
        [
          {
            "node": "Get Request",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Unauthorized Response3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Request": {
      "main": [
        [
          {
            "node": "Get Operator ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Magento Data": {
      "main": [
        [
          {
            "node": "Create Magento Product",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Magento Product": {
      "main": [
        [
          {
            "node": "Update Request to Approved",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Request to Approved": {
      "main": [
        [
          {
            "node": "Format Course Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Course Response": {
      "main": [
        [
          {
            "node": "Create Course Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Manager?4": {
      "main": [
        [
          {
            "node": "Get Partner Courses",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Unauthorized Response4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Partner Courses": {
      "main": [
        [
          {
            "node": "Partner Courses Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get User with Role": {
      "main": [
        [
          {
            "node": "Format Login Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Operator ID": {
      "main": [
        [
          {
            "node": "Prepare Magento Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Ticket1": {
      "main": [
        [
          {
            "node": "error6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Contact ?1": {
      "main": [
        [
          {
            "node": "contact_id3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Create Contact1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Contact1": {
      "main": [
        [
          {
            "node": "error5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "contact_id2": {
      "main": [
        [
          {
            "node": "Create Ticket1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "contact_id3": {
      "main": [
        [
          {
            "node": "Create Ticket1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Contact Odoo by Email1": {
      "main": [
        [
          {
            "node": "error4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ODOO1": {
      "main": [
        [
          {
            "node": "Get Contact Odoo by Email1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "error4": {
      "main": [
        [
          {
            "node": "500-4",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Has Contact ?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "error5": {
      "main": [
        [
          {
            "node": "500-5",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "contact_id2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "error6": {
      "main": [
        [
          {
            "node": "500-6",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Post message1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "error7": {
      "main": [
        [
          {
            "node": "500-7",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Create Request Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Post message1": {
      "main": [
        [
          {
            "node": "error7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Status": {
      "main": [
        [
          {
            "node": "Send Approved Email",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Rejected Email",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update Status Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Rejected Email": {
      "main": [
        [
          {
            "node": "Update Status Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Approved Email": {
      "main": [
        [
          {
            "node": "Update Status Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false,
    "errorWorkflow": "fHsgsGJzn3YxgmPK"
  },
  "versionId": "99733a0e-4bec-4bc0-8f61-4e2e30aedd06",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "f893a509eeee6b092086d07e58433a4356cbbf029f89f0eb3c157ad85ed9f33c"
  },
  "id": "eKL8d5pDOgdlo3xD",
  "tags": [
    {
      "updatedAt": "2025-07-12T13:04:03.605Z",
      "createdAt": "2025-07-12T13:04:03.605Z",
      "id": "W9o8r7YeRbv678pp",
      "name": "Vadim Tikhonov | 602"
    }
  ]
}