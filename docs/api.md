# API Documentation

## Overview

This application uses a proxy-based architecture where all API requests are routed through `/api/proxy` which forwards them to an n8n backend service. The proxy expects an `action` query parameter to determine which operation to perform.

All API requests use the `POST` method and send data in JSON format.

## Base URL

```
/api/proxy
```

## Authentication

Most endpoints (except `login` and `reset-password`) require Bearer token authentication.

**Header Format:**
```
Authorization: Bearer <token>
```

The token is returned from the login endpoint and should be included in all subsequent requests.

---

## Endpoints

### 1. Login

Authenticate a user with email and password.

**Action:** `login`

**URL:** `POST /api/proxy?action=login`

**Authentication:** Not required

**Request Body:**
```json
{
  "email": "user@example.com",
  "password": "userpassword"
}
```

**Response:**
```json
{
  "email": "user@example.com",
  "name": "User Name",
  "token": "jwt-token-string"
}
```

**Response Type:** `User`
```typescript
interface User {
  email: string;
  name: string;
  token?: string;
}
```

---

### 2. Get All Courses

Retrieve a list of all courses.

**Action:** `get-courses`

**URL:** `POST /api/proxy?action=get-courses`

**Authentication:** Required

**Request Body:**
```json
{}
```

**Response:**
```json
[
  {
    "id": 1,
    "title": "Course Title",
    "sku": "COURSE-SKU-001",
    "status": "active",
    "description": "Course description",
    "image": "https://example.com/image.jpg",
    "basePrice": 99.99,
    "available_dates": 5,
    "location": "Course Location"
  }
]
```

**Response Type:** `Course[]`
```typescript
interface Course {
  id: number;
  title: string;
  sku: string;
  status: 'active' | 'inactive';
  description: string;
  image: string;
  basePrice: number;
  available_dates?: number;
  location: string;
}
```

---

### 3. Get Single Course

Retrieve details of a specific course by ID.

**Action:** `get-course`

**URL:** `POST /api/proxy?action=get-course`

**Authentication:** Required

**Request Body:**
```json
{
  "course_id": 1
}
```

**Response:**
```json
{
  "id": 1,
  "title": "Course Title",
  "sku": "COURSE-SKU-001",
  "status": "active",
  "description": "Course description",
  "image": "https://example.com/image.jpg",
  "basePrice": 99.99,
  "available_dates": 5,
  "location": "Course Location"
}
```

**Response Type:** `Course`

---

### 4. Update Course

Update an existing course. Only specific fields can be updated.

**Action:** `update-course`

**URL:** `POST /api/proxy?action=update-course`

**Authentication:** Required

**Request Body:**
```json
{
  "id": 1,
  "title": "Updated Course Title",
  "status": "active",
  "basePrice": 149.99
}
```

**Response:**
```json
{
  "id": 1,
  "title": "Updated Course Title",
  "sku": "COURSE-SKU-001",
  "status": "active",
  "description": "Course description",
  "image": "https://example.com/image.jpg",
  "basePrice": 149.99,
  "location": "Location"
}
```

**Response Type:** `Course`

**Notes:**
- Only `id`, `title`, `status`, and `basePrice` can be updated
- Other fields (`sku`, `location`, `description`, `image`) are read-only
- `status` must be either `'active'` or `'inactive'`
- `basePrice` must be a non-negative number

---

### 5. Create Course

Create a new course.

**Action:** `create-course`

**URL:** `POST /api/proxy?action=create-course`

**Authentication:** Required

**Request Body:**
```json
{
  "title": "New Course Title",
  "sku": "COURSE-SKU-002",
  "status": "active",
  "description": "Course description",
  "image": "https://example.com/image.jpg",
  "basePrice": 99.99,
  "location": "Course Location"
}
```

**Response:**
```json
{
  "id": 2,
  "title": "New Course Title",
  "sku": "COURSE-SKU-002",
  "status": "active",
  "description": "Course description",
  "image": "https://example.com/image.jpg",
  "basePrice": 99.99,
  "location": "Course Location"
}
```

**Response Type:** `Course`

**Notes:**
- All fields except `id` are required
- `id` is auto-generated by the server
- `sku` must be unique
- `status` must be either `'active'` or `'inactive'`
- `basePrice` must be a non-negative number

---

### 6. Get Course Dates

Retrieve all available dates/events for a specific course.

**Action:** `get-dates`

**URL:** `POST /api/proxy?action=get-dates`

**Authentication:** Required

**Request Body:**
```json
{
  "course_id": 1
}
```

**Response:**
```json
[
  {
    "id": 1,
    "courseId": 1,
    "dateTime": "2025-03-15T14:00:00.000Z",
    "capacity": 20,
    "booked": 5,
    "duration": 180,
    "price": 99.99
  },
  {
    "id": 2,
    "courseId": 1,
    "dateTime": "2025-03-22T14:00:00.000Z",
    "capacity": 20,
    "booked": 12,
    "duration": 180,
    "price": 149.99
  }
]
```

**Response Type:** `CourseDate[]`
```typescript
interface CourseDate {
  id: number;
  courseId: number;
  dateTime: string; // ISO 8601 format
  capacity: number;
  booked: number;
  duration?: number; // Duration in minutes
  price: number; // Price for this specific date
}
```

---

### 7. Create Course Date

Create a new date/event for a specific course.

**Action:** `create-date`

**URL:** `POST /api/proxy?action=create-date`

**Authentication:** Required

**Request Body:**
```json
{
  "courseId": 1,
  "dateTime": "2025-03-15T14:00:00.000Z",
  "capacity": 20,
  "duration": 180
}
```

**Response:**
```json
{
  "id": 3,
  "courseId": 1,
  "dateTime": "2025-03-15T14:00:00.000Z",
  "capacity": 20,
  "booked": 0,
  "duration": 180
}
```

**Response Type:** `CourseDate`

**Notes:**
- `dateTime` must be in ISO 8601 format
- `capacity` must be a positive integer
- `duration` is optional and represents duration in minutes
- `id` is auto-generated by the server
- `booked` is initialized to 0

---

### 8. Delete Course Date

Delete an existing date/event from a course.

**Action:** `delete-date`

**URL:** `POST /api/proxy?action=delete-date`

**Authentication:** Required

**Request Body:**
```json
{
  "date_id": 1
}
```

**Response:**
```json
{
  "success": true
}
```

**Notes:**
- The date will be permanently deleted
- This action cannot be undone

---

### 9. Update Course Date

Update the price of an existing date/event.

**Action:** `update-date`

**URL:** `POST /api/proxy?action=update-date`

**Authentication:** Required

**Request Body:**
```json
{
  "date_id": 1,
  "price": 149.99
}
```

**Response:**
```json
{
  "success": true
}
```

**Notes:**
- Only the price can be updated for an existing date
- The price is specific to this date and can differ from the course's basePrice
- Use this to set custom pricing for specific dates (e.g., holiday pricing, early bird rates)

---

### 10. Change Password

Change the authenticated user's password.

**Action:** `change-password`

**URL:** `POST /api/proxy?action=change-password`

**Authentication:** Required

**Request Body:**
```json
{
  "password": "currentpassword",
  "newPassword": "newpassword123"
}
```

**Response:**
```json
{
  "success": true
}
```

**Error Response:**
```json
{
  "success": false,
  "message": "Current password is incorrect"
}
```

**Notes:**
- The response will include `success: false` if the current password is incorrect
- The new password should meet security requirements

---

### 11. Reset Password

Request a password reset email for a user account.

**Action:** `reset-password`

**URL:** `POST /api/proxy?action=reset-password`

**Authentication:** Not required

**Request Body:**
```json
{
  "email": "user@example.com"
}
```

**Response:**
```json
{
  "success": true
}
```

**Notes:**
- This endpoint sends a password reset email to the provided address
- The response is typically the same regardless of whether the email exists (for security)

---

### 12. Send Contact Message

Send a contact message from the authenticated user.

**Action:** `contact`

**URL:** `POST /api/proxy?action=contact`

**Authentication:** Required

**Request Body:**
```json
{
  "subject": "Support Request",
  "message": "I need help with my course access."
}
```

**Response:**
```json
{
  "success": true
}
```

**Notes:**
- Both `subject` and `message` are required
- The message will be associated with the authenticated user's account

---

## Error Handling

All endpoints may return errors in the following format:

**Client Errors (4xx):**
```json
{
  "error": "Error message describing the issue"
}
```

**Server Errors (5xx):**
```json
{
  "error": "Internal Proxy Error"
}
```

**Common HTTP Status Codes:**
- `200`: Success
- `400`: Bad Request (invalid data)
- `401`: Unauthorized (missing or invalid token)
- `404`: Not Found
- `500`: Internal Server Error

---

## Data Types Reference

### User
```typescript
interface User {
  email: string;
  name: string;
  token?: string;
}
```

### Course
```typescript
interface Course {
  id: number;
  title: string;
  sku: string;
  status: 'active' | 'inactive';
  description: string;
  image: string;
  basePrice: number;
  available_dates?: number;
  location: string;
}
```

### CourseDate
```typescript
interface CourseDate {
  id: number;
  courseId: number;
  dateTime: string; // ISO 8601 format (e.g., "2025-03-15T14:00:00.000Z")
  capacity: number;
  booked: number;
  duration?: number; // Duration in minutes
  price: number; // Price for this specific date (can differ from course basePrice)
}
```

---

## Mock Mode

The application includes a mock mode for development. When `NEXT_PUBLIC_N8N_API_URL` is not set, all API calls are simulated using local mock data instead of hitting the real backend.

To enable mock mode, simply don't set the `NEXT_PUBLIC_N8N_API_URL` environment variable.

---

## Examples

### Login Example
```javascript
const response = await fetch('/api/proxy?action=login', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    email: 'user@example.com',
    password: 'password123'
  })
});

const user = await response.json();
console.log(user.token); // Use this token for authenticated requests
```

### Get Courses Example
```javascript
const response = await fetch('/api/proxy?action=get-courses', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`
  },
  body: JSON.stringify({})
});

const courses = await response.json();
```

### Update Course Example
```javascript
const response = await fetch('/api/proxy?action=update-course', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`
  },
  body: JSON.stringify({
    id: 1,
    title: 'Updated Title',
    status: 'active',
    basePrice: 99.99
  })
});

const updatedCourse = await response.json();
```

### Create Course Example
```javascript
const response = await fetch('/api/proxy?action=create-course', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`
  },
  body: JSON.stringify({
    title: 'New Course',
    sku: 'NEW-COURSE-001',
    status: 'active',
    description: 'Course description',
    image: 'https://example.com/image.jpg',
    basePrice: 99.99,
    location: 'Berlin'
  })
});

const newCourse = await response.json();
```

### Create Date Example
```javascript
const response = await fetch('/api/proxy?action=create-date', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`
  },
  body: JSON.stringify({
    courseId: 1,
    dateTime: '2025-03-15T14:00:00.000Z',
    capacity: 20,
    duration: 180
  })
});

const newDate = await response.json();
```

### Delete Date Example
```javascript
const response = await fetch('/api/proxy?action=delete-date', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`
  },
  body: JSON.stringify({
    date_id: 1
  })
});

const result = await response.json();
```
